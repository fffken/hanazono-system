""")
HANAZONOã‚·ã‚¹ãƒ†ãƒ  å®Œå…¨ç‰ˆãƒ¡ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ )
ç¾ã—ã„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ + é”æˆç‡è©•ä¾¡ + ã‚³ã‚¹ãƒˆè¨ˆç®—)
""")
from datetime import datetime, timedelta)
import json)
import logging)
)
class EnhancedEmailSystem:)
)
    def __init__(self, settings_manager, logger=None):)
        self.settings = settings_manager)
        self.logger = logger or logging.getLogger(__name__))
        self.weather_emojis = {'æ™´ã‚Œ': 'â˜€ï¸', 'æ›‡ã‚Š': 'â˜ï¸', 'é›¨': 'ğŸŒ§ï¸', 'é›ª': 'â„ï¸', 'é›·': 'â›ˆï¸', 'éœ§': 'ğŸŒ«ï¸', 'ã‚¯ãƒªã‚¢': 'ğŸŒ¤ï¸'})
        self.season_emojis = {'æ˜¥': 'ğŸŒ¸', 'å¤': 'ğŸŒ»', 'ç§‹': 'ğŸ‚', 'å†¬': 'â„ï¸'})
        self.achievement_emojis = {'perfect': 'ğŸ†', 'excellent': 'ğŸ¥‡', 'good': 'ğŸ¥ˆ', 'fair': 'ğŸ¥‰', 'poor': 'ğŸ“ˆ', 'improving': 'â¬†ï¸'})
        self.battery_emojis = {'high': 'ğŸ”‹', 'medium': 'ğŸ”¶', 'low': 'ğŸ”»', 'charging': 'âš¡'})
        self.daily_targets = {'solar_generation': 12.0, 'battery_efficiency': 85.0, 'cost_savings': 400.0})
)
    def generate_complete_report(self, solar_data, weather_data, battery_info):)
        """å®Œå…¨ç‰ˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ""")
        timestamp = datetime.now())
        achievements = self._calculate_daily_achievements(solar_data))
        cost_analysis = self._calculate_cost_savings(solar_data))
        weather_analysis = self._analyze_weather(weather_data))
        recommendations = self._generate_recommendations(weather_data, achievements))
        html_report = self._generate_html_report(timestamp, solar_data, weather_data, battery_info, achievements, cost_analysis, weather_analysis, recommendations))
        return html_report)
)
    def _calculate_daily_achievements(self, solar_data):)
        """æ—¥æ¬¡é”æˆç‡è¨ˆç®—""")
        achievements = {})
        generation = self._extract_solar_generation(solar_data))
        solar_rate = min(100, generation / self.daily_targets['solar_generation'] * 100))
        achievements['solar'] = {'value': generation, 'target': self.daily_targets['solar_generation'], 'rate': solar_rate, 'emoji': self._get_achievement_emoji(solar_rate / 100), 'grade': self._get_grade(solar_rate), 'message': f"{generation:.1f}kWh / {self.daily_targets['solar_generation']:.1f}kWh"})
        battery_eff = self._calculate_battery_efficiency(solar_data))
        achievements['battery'] = {'value': battery_eff, 'target': self.daily_targets['battery_efficiency'], 'rate': min(100, battery_eff / self.daily_targets['battery_efficiency'] * 100), 'emoji': self._get_achievement_emoji(battery_eff / self.daily_targets['battery_efficiency']), 'grade': self._get_grade(battery_eff), 'message': f'{battery_eff:.1f}% åŠ¹ç‡'})
        return achievements)
)
    def _calculate_cost_savings(self, solar_data):)
        """ã‚³ã‚¹ãƒˆç¯€ç´„è¨ˆç®—""")
        electricity_rates = {'day': 25.8, 'night': 22.67})
        generation = self._extract_solar_generation(solar_data))
        consumption = self._extract_consumption(solar_data))
        solar_savings = generation * electricity_rates['day'])
        battery_savings = self._calculate_battery_savings(solar_data))
        total_savings = solar_savings + battery_savings)
        monthly_projection = total_savings * 30)
        yearly_projection = total_savings * 365)
        return {'daily_savings': total_savings, 'monthly_projection': monthly_projection, 'yearly_projection': yearly_projection, 'solar_contribution': solar_savings, 'battery_contribution': battery_savings, 'achievement_rate': min(100, total_savings / self.daily_targets['cost_savings'] * 100), 'emoji': 'ğŸ’°' if total_savings >= self.daily_targets['cost_savings'] else 'ğŸ’µ'})
)
    def _analyze_weather(self, weather_data):)
        """å¤©æ°—äºˆå ±åˆ†æ""")
        if not weather_data:)
            return {'status': 'no_data', 'emoji': 'â“', 'message': 'å¤©æ°—ãƒ‡ãƒ¼ã‚¿ãªã—'})
        today = weather_data.get('today', {}))
        tomorrow = weather_data.get('tomorrow', {}))
        today_weather = today.get('weather', 'ä¸æ˜'))
        tomorrow_weather = tomorrow.get('weather', 'ä¸æ˜'))
        solar_forecast = self._calculate_solar_forecast(today_weather, tomorrow_weather))
        return {'today': {'weather': today_weather, 'emoji': self.weather_emojis.get(today_weather, 'ğŸŒ¤ï¸'), 'solar_potential': solar_forecast['today']}, 'tomorrow': {'weather': tomorrow_weather, 'emoji': self.weather_emojis.get(tomorrow_weather, 'ğŸŒ¤ï¸'), 'solar_potential': solar_forecast['tomorrow']}, 'recommendation': solar_forecast['recommendation']})
)
    def _generate_recommendations(self, weather_data, achievements):)
        """å¤©æ°—ã¨é”æˆç‡ã«åŸºã¥ãæ¨å¥¨è¨­å®š""")
        recommendations = [])
        if weather_data:)
            today_weather = weather_data.get('today', {}).get('weather', ''))
            if 'æ™´ã‚Œ' in today_weather:)
                recommendations.append({'parameter': 'charge_current', 'value': 15, 'unit': 'A', 'reason': 'â˜€ï¸ æ™´å¤©äºˆå ±ã®ãŸã‚å……é›»é›»æµã‚’å¢—åŠ ', 'param_id': '07', 'priority': 'high', 'emoji': 'âš¡'}))
            elif 'é›¨' in today_weather:)
                recommendations.append({'parameter': 'discharge_cutoff', 'value': 40, 'unit': '%', 'reason': 'ğŸŒ§ï¸ é›¨å¤©äºˆå ±ã®ãŸã‚æ”¾é›»ã‚’æ§ãˆã‚ã«', 'param_id': '62', 'priority': 'medium', 'emoji': 'ğŸ”‹'}))
        if achievements.get('solar', {}).get('rate', 0) < 80:)
            recommendations.append({'parameter': 'boost_charge_time', 'value': 60, 'unit': 'åˆ†', 'reason': 'ğŸ“ˆ ç™ºé›»é‡å‘ä¸Šã®ãŸã‚ãƒ–ãƒ¼ã‚¹ãƒˆå……é›»æ™‚é–“å»¶é•·', 'param_id': '10', 'priority': 'medium', 'emoji': 'âš¡'}))
        return recommendations)
)
    def _generate_html_report(self, timestamp, solar_data, weather_data, battery_info, achievements, cost_analysis, weather_analysis, recommendations):)
        """ç¾ã—ã„HTMLãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ""")
        overall_grade = self._calculate_overall_grade(achievements, cost_analysis))
        html = f"""\n        <!DOCTYPE html>\n        <html>\n        <head>\n            <meta charset="UTF-8">\n            <title>HANAZONOã‚·ã‚¹ãƒ†ãƒ  æœ€é©åŒ–ãƒ¬ãƒãƒ¼ãƒˆ</title>\n            <style>\n                .achievement-bar {{\n                    background: #e0e0e0;\n                    border-radius: 10px;\n                    height: 20px;\n                    margin: 5px 0;\n                    overflow: hidden;\n                }}\n                .achievement-fill {{\n                    height: 100%;\n                    background: linear-gradient(90deg, #4CAF50, #45a049);\n                    transition: width 0.3s ease;\n                }}\n                .recommendation-item {{\n                    background: #f8f9fa;\n                    border-left: 4px solid #4CAF50;\n                    padding: 10px;\n                    margin: 10px 0;\n                    border-radius: 5px;\n                }}\n                .high-priority {{ border-left-color: #FF5722; }}\n                .medium-priority {{ border-left-color: #FF9800; }}\n            </style>\n        </head>\n        <body style="font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">\n            <div style="max-width: 600px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); overflow: hidden;">\n\n                <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->\n                <div style="background: linear-gradient(90deg, #4CAF50, #45a049); color: white; padding: 25px; text-align: center;">\n                    <h1 style="margin: 0; font-size: 24px;">ğŸŒ» HANAZONOã‚·ã‚¹ãƒ†ãƒ </h1>\n                    <h2 style="margin: 5px 0 0 0; font-size: 18px; opacity: 0.9;">æœ€é©åŒ–ãƒ¬ãƒãƒ¼ãƒˆ</h2>\n                    <p style="margin: 5px 0 0 0; opacity: 0.8;">{timestamp.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M')}</p>\n                </div>\n\n                <!-- ç·åˆè©•ä¾¡ -->\n                <div style="padding: 20px; text-align: center; background: #f8f9fa;">\n                    <h3 style="margin: 0 0 10px 0; color: #333;">ğŸ“Š ä»Šæ—¥ã®ç·åˆè©•ä¾¡</h3>\n                    <div style="font-size: 48px; margin: 10px 0;">{overall_grade['emoji']}</div>\n                    <div style="font-size: 20px; font-weight: bold; color: {overall_grade['color']};">{overall_grade['grade']}</div>\n                    <div style="font-size: 14px; color: #666; margin-top: 5px;">{overall_grade['message']}</div>\n                </div>\n\n                <!-- ãƒãƒƒãƒ†ãƒªãƒ¼çŠ¶æ³ -->\n                <div style="padding: 20px; border-bottom: 1px solid #eee;">\n                    <h3 style="margin: 0 0 15px 0; color: #333; display: flex; align-items: center;">\n                        ğŸ”‹ ç¾åœ¨ã®ãƒãƒƒãƒ†ãƒªãƒ¼çŠ¶æ³\n                    </h3>\n                    <div style="background: #f0f0f0; padding: 15px; border-radius: 10px; font-family: monospace;">\n                        {battery_info}\n                    </div>\n                </div>\n\n                <!-- é”æˆç‡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->\n                <div style="padding: 20px; border-bottom: 1px solid #eee;">\n                    <h3 style="margin: 0 0 15px 0; color: #333;">ğŸ¯ ä»Šæ—¥ã®é”æˆçŠ¶æ³</h3>\n\n                    <!-- å¤ªé™½å…‰ç™ºé›» -->\n                    <div style="margin-bottom: 20px;">\n                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">\n                            <span style="font-weight: bold;">{achievements['solar']['emoji']} å¤ªé™½å…‰ç™ºé›»</span>\n                            <span style="color: #666;">{achievements['solar']['message']}</span>\n                        </div>\n                        <div class="achievement-bar">\n                            <div class="achievement-fill" style="width: {achievements['solar']['rate']:.1f}%;"></div>\n                        </div>\n                        <div style="font-size: 12px; color: #666; text-align: right;">{achievements['solar']['rate']:.1f}% - {achievements['solar']['grade']}</div>\n                    </div>\n\n                    <!-- ãƒãƒƒãƒ†ãƒªãƒ¼åŠ¹ç‡ -->\n                    <div style="margin-bottom: 20px;">\n                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">\n                            <span style="font-weight: bold;">{achievements['battery']['emoji']} ãƒãƒƒãƒ†ãƒªãƒ¼åŠ¹ç‡</span>\n                            <span style="color: #666;">{achievements['battery']['message']}</span>\n                        </div>\n                        <div class="achievement-bar">\n                            <div class="achievement-fill" style="width: {achievements['battery']['rate']:.1f}%;"></div>\n                        </div>\n                        <div style="font-size: 12px; color: #666; text-align: right;">{achievements['battery']['rate']:.1f}% - {achievements['battery']['grade']}</div>\n                    </div>\n                </div>\n\n                <!-- ã‚³ã‚¹ãƒˆåˆ†æ -->\n                <div style="padding: 20px; border-bottom: 1px solid #eee;">\n                    <h3 style="margin: 0 0 15px 0; color: #333;">{cost_analysis['emoji']} é›»æ°—ä»£ç¯€ç´„åŠ¹æœ</h3>\n                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">\n                        <div style="text-align: center; background: #e8f5e8; padding: 15px; border-radius: 10px;">\n                            <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">Â¥{cost_analysis['daily_savings']:.0f}</div>\n                            <div style="font-size: 12px; color: #666;">ä»Šæ—¥ã®ç¯€ç´„</div>\n                        </div>\n                        <div style="text-align: center; background: #e3f2fd; padding: 15px; border-radius: 10px;">\n                            <div style="font-size: 24px; font-weight: bold; color: #2196F3;">Â¥{cost_analysis['monthly_projection']:.0f}</div>\n                            <div style="font-size: 12px; color: #666;">æœˆé–“äºˆæ¸¬</div>\n                        </div>\n                    </div>\n                    <div style="margin-top: 15px; font-size: 14px; color: #666; text-align: center;">\n                        å¹´é–“äºˆæ¸¬ç¯€ç´„é¡: <span style="font-weight: bold; color: #4CAF50;">Â¥{cost_analysis['yearly_projection']:,.0f}</span>\n                    </div>\n                </div>\n\n                <!-- å¤©æ°—äºˆå ± -->\n                <div style="padding: 20px; border-bottom: 1px solid #eee;">\n                    <h3 style="margin: 0 0 15px 0; color: #333;">ğŸŒ¤ï¸ å¤©æ°—äºˆå ±ã¨ç™ºé›»äºˆæ¸¬</h3>\n                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">\n                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">\n                            <div style="font-size: 32px; margin-bottom: 5px;">{weather_analysis['today']['emoji']}</div>\n                            <div style="font-weight: bold;">ä»Šæ—¥</div>\n                            <div style="font-size: 14px; color: #666;">{weather_analysis['today']['weather']}</div>\n                            <div style="font-size: 12px; color: #4CAF50;">ç™ºé›»äºˆæ¸¬: {weather_analysis['today']['solar_potential']}</div>\n                        </div>\n                        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px;">\n                            <div style="font-size: 32px; margin-bottom: 5px;">{weather_analysis['tomorrow']['emoji']}</div>\n                            <div style="font-weight: bold;">æ˜æ—¥</div>\n                            <div style="font-size: 14px; color: #666;">{weather_analysis['tomorrow']['weather']}</div>\n                            <div style="font-size: 12px; color: #4CAF50;">ç™ºé›»äºˆæ¸¬: {weather_analysis['tomorrow']['solar_potential']}</div>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- æ¨å¥¨è¨­å®š -->\n                <div style="padding: 20px; border-bottom: 1px solid #eee;">\n                    <h3 style="margin: 0 0 15px 0; color: #333;">âš™ï¸ ä»Šæ—¥ã®æ¨å¥¨è¨­å®šå¤‰æ›´</h3>\n                    {self._generate_recommendations_html(recommendations)}\n                </div>\n\n                <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->\n                <div style="padding: 20px; text-align: center; background: #f8f9fa; color: #666;">\n                    <p style="margin: 0; font-size: 12px;">ğŸŒ» HANAZONOã‚·ã‚¹ãƒ†ãƒ  - å¤ªé™½å…‰ç™ºé›»æœ€é©åŒ–AI</p>\n                    <p style="margin: 5px 0 0 0; font-size: 12px;">æ¯æ—¥ã®ç©ã¿é‡ã­ã§åœ°çƒã«å„ªã—ã„ç”Ÿæ´»ã‚’å®Ÿç¾ ğŸŒ</p>\n                </div>\n            </div>\n        </body>\n        </html>\n        """)
        return html)
)
    def _generate_recommendations_html(self, recommendations):)
        """æ¨å¥¨è¨­å®šã®HTMLç”Ÿæˆ""")
        if not recommendations:)
            return '<div style="text-align: center; color: #666; font-style: italic;">ä»Šæ—¥ã¯è¨­å®šå¤‰æ›´ã®æ¨å¥¨ã¯ã‚ã‚Šã¾ã›ã‚“ ğŸ‘</div>')
        html = '')
        for rec in recommendations:)
            priority_class = f"{rec['priority']}-priority" if rec['priority'] in ['high', 'medium'] else '')
            html += f"""\n            <div class="recommendation-item {priority_class}">\n                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">\n                    <span style="font-weight: bold;">{rec['emoji']} {rec['parameter']}</span>\n                    <span style="background: #4CAF50; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">\n                        ID: {rec['param_id']}\n                    </span>\n                </div>\n                <div style="font-size: 18px; color: #4CAF50; font-weight: bold; margin: 5px 0;">\n                    æ¨å¥¨å€¤: {rec['value']} {rec['unit']}\n                </div>\n                <div style="font-size: 14px; color: #666;">\n                    ç†ç”±: {rec['reason']}\n                </div>\n            </div>\n            """)
        return html)
)
    def _extract_solar_generation(self, solar_data):)
        """å¤ªé™½å…‰ç™ºé›»é‡ã‚’æŠ½å‡ºï¼ˆãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼‰""")
        return 10.5)
)
    def _extract_consumption(self, solar_data):)
        """æ¶ˆè²»é›»åŠ›ã‚’æŠ½å‡ºï¼ˆãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼‰""")
        return 8.2)
)
    def _calculate_battery_efficiency(self, solar_data):)
        """ãƒãƒƒãƒ†ãƒªãƒ¼åŠ¹ç‡ã‚’è¨ˆç®—ï¼ˆãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼‰""")
        return 87.5)
)
    def _calculate_battery_savings(self, solar_data):)
        """ãƒãƒƒãƒ†ãƒªãƒ¼ç¯€ç´„åŠ¹æœã‚’è¨ˆç®—ï¼ˆãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼‰""")
        return 150.0)
)
    def _calculate_solar_forecast(self, today_weather, tomorrow_weather):)
        """å¤ªé™½å…‰ç™ºé›»äºˆæ¸¬""")
)
        def get_potential(weather):)
            if 'æ™´ã‚Œ' in weather:)
                return 'é«˜ã„ â˜€ï¸')
            elif 'æ›‡ã‚Š' in weather:)
                return 'æ™®é€š â˜ï¸')
            elif 'é›¨' in weather:)
                return 'ä½ã„ ğŸŒ§ï¸')
            else:)
                return 'æ™®é€š ğŸŒ¤ï¸')
        return {'today': get_potential(today_weather), 'tomorrow': get_potential(tomorrow_weather), 'recommendation': 'æ™´å¤©ã‚’æ´»ç”¨ã—ãŸå……é›»ãŒãŠã™ã™ã‚' if 'æ™´ã‚Œ' in today_weather else 'é›¨å¤©ã«å‚™ãˆãŸç¯€é›»ã‚’æ¨å¥¨'})
)
    def _get_achievement_emoji(self, rate):)
        """é”æˆç‡ã«åŸºã¥ãçµµæ–‡å­—å–å¾—""")
        if rate >= 1.0:)
            return 'ğŸ†')
        elif rate >= 0.9:)
            return 'ğŸ¥‡')
        elif rate >= 0.8:)
            return 'ğŸ¥ˆ')
        elif rate >= 0.7:)
            return 'ğŸ¥‰')
        else:)
            return 'ğŸ“ˆ')
)
    def _get_grade(self, rate):)
        """é”æˆç‡ã«åŸºã¥ãã‚°ãƒ¬ãƒ¼ãƒ‰å–å¾—""")
        if rate >= 95:)
            return 'PERFECT')
        elif rate >= 85:)
            return 'EXCELLENT')
        elif rate >= 75:)
            return 'GOOD')
        elif rate >= 65:)
            return 'FAIR')
        else:)
            return 'NEEDS IMPROVEMENT')
)
    def _calculate_overall_grade(self, achievements, cost_analysis):)
        """ç·åˆè©•ä¾¡è¨ˆç®—""")
        solar_rate = achievements.get('solar', {}).get('rate', 0))
        battery_rate = achievements.get('battery', {}).get('rate', 0))
        cost_rate = cost_analysis.get('achievement_rate', 0))
        overall_rate = (solar_rate + battery_rate + cost_rate) / 3)
        if overall_rate >= 90:)
            return {'emoji': 'ğŸ†', 'grade': 'PERFECT', 'color': '#FFD700', 'message': 'ç´ æ™´ã‚‰ã—ã„ï¼å®Œç’§ãªä¸€æ—¥ã§ã—ãŸ'})
        elif overall_rate >= 80:)
            return {'emoji': 'ğŸ¥‡', 'grade': 'EXCELLENT', 'color': '#4CAF50', 'message': 'å„ªç§€ï¼ã¨ã¦ã‚‚è‰¯ã„çµæœã§ã™'})
        elif overall_rate >= 70:)
            return {'emoji': 'ğŸ¥ˆ', 'grade': 'GOOD', 'color': '#2196F3', 'message': 'è‰¯å¥½ï¼é †èª¿ã«é€²æ­©ã—ã¦ã„ã¾ã™'})
        elif overall_rate >= 60:)
            return {'emoji': 'ğŸ¥‰', 'grade': 'FAIR', 'color': '#FF9800', 'message': 'æ™®é€šï¼æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™'})
        else:)
            return {'emoji': 'ğŸ“ˆ', 'grade': 'IMPROVING', 'color': '#f44336', 'message': 'é ‘å¼µã£ã¦ï¼æ˜æ—¥ã¯ã‚‚ã£ã¨è‰¯ããªã‚Šã¾ã™'})