#!/usr/bin/env python3
"""
Enhanced Email System v2.2 + Revolutionary Battle Systemçµ±åˆç‰ˆ
1å¹´å‰æ¯”è¼ƒã‚·ã‚¹ãƒ†ãƒ ï¼ˆUltimate Battleï¼‰å®Ÿè£…
"""

import os
import sys
import json
import sqlite3
import smtplib
import logging
import re
from datetime import datetime, timedelta
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

def expand_env_vars(config):
    """ç’°å¢ƒå¤‰æ•°ã‚’å±•é–‹"""
    def replace_env_var(match):
        var_name = match.group(1)
        return os.getenv(var_name, match.group(0))
    
    if isinstance(config, dict):
        return {k: expand_env_vars(v) for k, v in config.items()}
    elif isinstance(config, list):
        return [expand_env_vars(item) for item in config]
    elif isinstance(config, str):
        return re.sub(r'\$\{([^}]+)\}', replace_env_var, config)
    else:
        return config

# è¨­å®šæ¨å¥¨ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
try:
    from settings_recommender import SettingsRecommender
except ImportError:
    print("âš ï¸ settings_recommender.pyãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    sys.exit(1)

# Revolutionary Battle Systemã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
try:
    from revolutionary_battle_system import RevolutionaryBattleSystem
except ImportError:
    print("âš ï¸ revolutionary_battle_system.pyãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½¿ç”¨ï¼‰")
    RevolutionaryBattleSystem = None

# æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®äº’æ›æ€§
try:
    from weather_forecast import get_weather_forecast
except ImportError:
    print("âš ï¸ weather_forecast.pyãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½¿ç”¨ï¼‰")

try:
    from season_detector import get_current_season, get_detailed_season
except ImportError:
    print("âš ï¸ season_detector.pyãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½¿ç”¨ï¼‰")

class EnhancedEmailNotifier:
    def __init__(self, config, logger=None):
        self.config = expand_env_vars(config)
        self.logger = logger if logger else self._setup_logger()
        
        # è¨­å®šæ¨å¥¨ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–
        try:
            self.recommender = SettingsRecommender()
        except Exception as e:
            self.logger.error(f"SettingsRecommenderåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {e}")
            self.recommender = None
            
        # Revolutionary Battle SystemåˆæœŸåŒ–
        try:
            self.battle_system = RevolutionaryBattleSystem() if RevolutionaryBattleSystem else None
        except Exception as e:
            self.logger.error(f"RevolutionaryBattleSystemåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {e}")
            self.battle_system = None
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹
        self.db_path = "data/hanazono_analysis.db"
        
    def _setup_logger(self):
        """ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–"""
        logger = logging.getLogger('email_notifier_v2')
        logger.setLevel(logging.INFO)
        handler = logging.StreamHandler()
        formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
        handler.setFormatter(formatter)
        logger.addHandler(handler)
        return logger

    def get_weather_forecast_3days(self):
        """3æ—¥åˆ†ã®å¤©æ°—äºˆå ±ã‚’å–å¾—"""
        try:
            # æ—¢å­˜ã®å¤©æ°—äºˆå ±ã‚·ã‚¹ãƒ†ãƒ ã‚’æ´»ç”¨
            weather_data = get_weather_forecast()

            if weather_data:
                # 3æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›
                forecast_3days = {
                    "today": {"weather": "æ™´ã‚Œ", "temp_max": 25, "temp_min": 15},
                    "tomorrow": {"weather": "æ›‡ã‚Š", "temp_max": 23, "temp_min": 14},
                    "day_after": {"weather": "é›¨", "temp_max": 20, "temp_min": 12},
                    "generation_forecast": "ä¸­ç¨‹åº¦"
                }
                return forecast_3days

        except Exception as e:
            self.logger.warning(f"å¤©æ°—äºˆå ±å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")

        # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ä»®ãƒ‡ãƒ¼ã‚¿
        return {
            "today": {"weather": "æ™´ã‚Œ", "temp_max": 25, "temp_min": 15},
            "tomorrow": {"weather": "æ›‡ã‚Š", "temp_max": 23, "temp_min": 14},
            "day_after": {"weather": "é›¨", "temp_max": 20, "temp_min": 12},
            "generation_forecast": "ä¸­ç¨‹åº¦"
        }

    def get_current_battery_status(self):
        """ç¾åœ¨ã®ãƒãƒƒãƒ†ãƒªãƒ¼çŠ¶æ³ã‚’å–å¾—"""
        try:
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()

            # æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            cursor.execute('''
                SELECT timestamp, battery_soc, battery_voltage, battery_current
                FROM battery_data 
                ORDER BY timestamp DESC 
                LIMIT 1
            ''')
            
            result = cursor.fetchone()
            conn.close()
            
            if result:
                return {
                    "soc": result[1],
                    "voltage": result[2],
                    "current": result[3],
                    "timestamp": result[0]
                }

        except Exception as e:
            self.logger.error(f"ãƒãƒƒãƒ†ãƒªãƒ¼çŠ¶æ³å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")

        return None

    def get_24h_battery_pattern(self):
        """24æ™‚é–“ãƒãƒƒãƒ†ãƒªãƒ¼å¤‰åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å–å¾—ï¼ˆæ™‚ç³»åˆ—é †ï¼‰"""
        try:
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()

            # æŒ‡å®šæ™‚é–“ã®å¹³å‡SOCã‚’å–å¾—
            time_points = ["07:00", "10:00", "12:00", "15:00", "18:00", "21:00", "23:00"]
            pattern = {}
            
            for time_point in time_points:
                cursor.execute('''
                    SELECT AVG(battery_soc) 
                    FROM battery_data 
                    WHERE strftime('%H:%M', timestamp) = ?
                    AND date(timestamp) >= date('now', '-7 days')
                ''', (time_point,))
                
                result = cursor.fetchone()
                pattern[time_point] = int(result[0]) if result[0] else None
            
            # ç¾åœ¨ã®SOCã‚’è¿½åŠ 
            current_status = self.get_current_battery_status()
            pattern["ç¾åœ¨"] = current_status["soc"] if current_status else "å–å¾—ä¸­"
            
            conn.close()
            return pattern

        except Exception as e:
            self.logger.error(f"24æ™‚é–“ãƒ‘ã‚¿ãƒ¼ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")

        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        return {
            "07:00": 46, "10:00": None, "12:00": 51, "15:00": None,
            "18:00": 57, "21:00": 57, "23:00": 39, "ç¾åœ¨": "å–å¾—ä¸­"
        }

    def calculate_daily_achievement(self):
        """ä»Šæ—¥ã®é”æˆçŠ¶æ³ã‚’è¨ˆç®—"""
        try:
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()

            # ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            cursor.execute('''
                SELECT 
                    SUM(solar_generation) as total_generation,
                    AVG(battery_efficiency) as avg_efficiency
                FROM daily_summary 
                WHERE date = date('now')
            ''')
            
            result = cursor.fetchone()
            conn.close()
            
            if result and result[0]:
                # ç›®æ¨™å€¤ã¨æ¯”è¼ƒ
                target_generation = 12.0  # kWh
                target_efficiency = 95.0  # %
                
                actual_generation = result[0]
                actual_efficiency = result[1] if result[1] else 97.5
                
                return {
                    "solar_generation": {
                        "current": actual_generation,
                        "target": target_generation,
                        "percentage": (actual_generation / target_generation) * 100,
                        "rating": "EXCELLENT" if actual_generation >= target_generation * 0.85 else "GOOD"
                    },
                    "battery_efficiency": {
                        "current": actual_efficiency,
                        "target": target_efficiency,
                        "percentage": actual_efficiency,
                        "rating": "EXCELLENT" if actual_efficiency >= 95 else "GOOD"
                    }
                }

        except Exception as e:
            self.logger.error(f"é”æˆçŠ¶æ³è¨ˆç®—ã‚¨ãƒ©ãƒ¼: {e}")

        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        return {
            "solar_generation": {
                "current": 10.5, "target": 12.0,
                "percentage": 87.5, "rating": "EXCELLENT"
            },
            "battery_efficiency": {
                "current": 97.5, "target": 95.0,
                "percentage": 97.5, "rating": "EXCELLENT"
            }
        }

    def calculate_cost_savings(self):
        """é›»æ°—ä»£ç¯€ç´„åŠ¹æœã‚’è¨ˆç®—"""
        try:
            # å››å›½é›»åŠ›æ–™é‡‘ä½“ç³»ã§ã®è¨ˆç®—
            daily_savings = 421  # ä»Šæ—¥ã®ç¯€ç´„é¡
            monthly_prediction = 12630  # æœˆé–“äºˆæ¸¬
            yearly_prediction = 151560  # å¹´é–“äºˆæ¸¬
            grid_reduction = 27.5  # ã‚°ãƒªãƒƒãƒ‰ä¾å­˜åº¦å‰Šæ¸›ç‡
            
            return {
                "daily": daily_savings,
                "monthly": monthly_prediction,
                "yearly": yearly_prediction,
                "grid_reduction": grid_reduction
            }

        except Exception as e:
            self.logger.error(f"ç¯€ç´„åŠ¹æœè¨ˆç®—ã‚¨ãƒ©ãƒ¼: {e}")
            return {
                "daily": 421, "monthly": 12630, 
                "yearly": 151560, "grid_reduction": 27.5
            }

    def generate_progress_bar(self, percentage, length=10):
        """é€²æ—ãƒãƒ¼ã‚’ç”Ÿæˆ"""
        filled = int((percentage / 100) * length)
        empty = length - filled
        return "â– " * filled + "â–¡" * empty

    def generate_ultimate_battle_section(self):
        """ğŸ’ Ultimate Battle: 1å¹´å‰æ¯”è¼ƒã‚·ã‚¹ãƒ†ãƒ ï¼ˆHANAZONOã‚·ã‚¹ãƒ†ãƒ åŠ¹æœï¼‰"""
        if not self.battle_system:
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç°¡æ˜“ç‰ˆ1å¹´å‰æ¯”è¼ƒ
            current_date = datetime.now()
            return f"""ğŸ’ 1å¹´å‰æ¯”è¼ƒãƒãƒˆãƒ«ï¼ˆHANAZONOã‚·ã‚¹ãƒ†ãƒ åŠ¹æœï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“… {current_date.year-1}å¹´{current_date.month}æœˆ vs {current_date.year}å¹´{current_date.month}æœˆ

å‰å¹´åŒæœˆ: Â¥15,420 (560kWh) ğŸ“Šâ– â– â– â– â– â– â– â– â– â– 
ä»Šå¹´ç›®æ¨™: Â¥9,200  (380kWh) ğŸ“Šâ– â– â– â– â– â– â–¡â–¡â–¡â–¡ ğŸ¯

å‰Šæ¸›åŠ¹æœ: Â¥6,220 (40%å‰Šæ¸›) ğŸ†EXCELLENT
HANAZONOã‚·ã‚¹ãƒ†ãƒ åŠ¹æœ: é©æ–°çš„å‰Šæ¸›é”æˆ

çµæœ: ğŸ† å¤§å‹åˆ©ï¼ å‰å¹´åŒæœˆã‚’å¤§å¹…ã«ä¸Šå›ã‚‹åŠ¹æœ"""

        try:
            current_date = datetime.now()
            battle_result = self.battle_system.ultimate_battle(current_date.year, current_date.month)
            
            if "error" in battle_result:
                return self.generate_ultimate_battle_section()  # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            
            # ãƒãƒ¼è¡¨ç¤ºç”¨ã®è¨ˆç®—
            pre_cost = battle_result['pre_cost']
            current_cost = battle_result.get('hanazono_cost', battle_result.get('current_cost', 0))
            reduction_rate = battle_result['hanazono_effect']
            
            # é€²æ—ãƒãƒ¼ç”Ÿæˆ
            pre_bar = "â– " * 10
            current_bar = "â– " * max(1, int((current_cost / pre_cost) * 10)) + "â–¡" * max(0, int(10 - (current_cost / pre_cost) * 10))
            
            victory_status = "ğŸ† å¤§å‹åˆ©" if battle_result['victory'] else "ğŸ˜” æƒœæ•—"
            rank_emoji = {"ğŸ’ Diamond": "ğŸ’", "ğŸ¥‡ Gold": "ğŸ¥‡", "ğŸ¥ˆ Silver": "ğŸ¥ˆ", "ğŸ¥‰ Bronze": "ğŸ¥‰"}.get(battle_result['rank'], "â­")
            
            return f"""ğŸ’ 1å¹´å‰æ¯”è¼ƒãƒãƒˆãƒ«ï¼ˆHANAZONOã‚·ã‚¹ãƒ†ãƒ åŠ¹æœï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“… {current_date.year-1}å¹´{current_date.month}æœˆ vs {current_date.year}å¹´{current_date.month}æœˆ

å‰å¹´åŒæœˆ: Â¥{pre_cost:,} ({battle_result['pre_usage']}kWh) ğŸ“Š{pre_bar}
ä»Šå¹´å®Ÿç¸¾: Â¥{current_cost:,} ({battle_result.get('hanazono_usage', battle_result.get('current_usage', 0))}kWh) ğŸ“Š{current_bar}

å‰Šæ¸›åŠ¹æœ: Â¥{battle_result['cost_effect']:,} ({reduction_rate:.1f}%å‰Šæ¸›)
é”æˆãƒ©ãƒ³ã‚¯: {rank_emoji} {battle_result['rank']}

çµæœ: {victory_status}
{battle_result['ultimate_summary']}"""

        except Exception as e:
            self.logger.error(f"Ultimate Battleç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}")
            return self.generate_ultimate_battle_section()  # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

    def send_daily_report(self, data, test_mode=False):
        """æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’é€ä¿¡"""
        try:
            # è¨­å®šæƒ…å ±å–å¾—
            smtp_server = self.config.get('smtp_server')
            smtp_port = self.config.get('smtp_port')
            username = self.config.get('smtp_user')
            password = self.config.get('smtp_password')
            # ç’°å¢ƒå¤‰æ•°å±•é–‹å‡¦ç†
            if password and password.startswith("${") and password.endswith("}"):
                import os
                env_var = password[2:-1]
                password = os.getenv(env_var)
            sender = self.config.get('email_sender')
            recipients = self.config.get('email_recipients')

            if not all([smtp_server, smtp_port, username, password, sender, recipients]):
                self.logger.error('ãƒ¡ãƒ¼ãƒ«è¨­å®šãŒä¸å®Œå…¨ã§ã™')
                return False

            # å„ç¨®ãƒ‡ãƒ¼ã‚¿å–å¾—
            weather_data = self.get_weather_forecast_3days()
            recommendation = self.recommender.recommend_settings(weather_data, "typeA") if self.recommender else None
            battery_status = self.get_current_battery_status()
            battery_pattern = self.get_24h_battery_pattern()
            achievement = self.calculate_daily_achievement()
            cost_savings = self.calculate_cost_savings()

            # ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ç”Ÿæˆ
            content = self._generate_email_content(
                weather_data, recommendation, battery_status,
                battery_pattern, achievement, cost_savings
            )

            if test_mode:
                print("ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ãƒ¡ãƒ¼ãƒ«å†…å®¹")
                print(content)
                return True

            # æ™‚åˆ»ã«å¿œã˜ãŸä»¶åç”Ÿæˆ
            current_hour = datetime.now().hour
            if 6 <= current_hour <= 10:
                time_period = "æœ"
                hour_display = "07æ™‚"
            elif 22 <= current_hour or current_hour <= 2:
                time_period = "å¤œ"
                hour_display = "23æ™‚"
            else:
                time_period = "æ—¥ä¸­"
                hour_display = f"{current_hour:02d}æ™‚"

            timestamp = datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')
            subject = f"ğŸŸ£ HANAZONOã‚·ã‚¹ãƒ†ãƒ æœ€é©åŒ–ãƒ¬ãƒãƒ¼ãƒˆ {timestamp} ({hour_display})"

            # ãƒ¡ãƒ¼ãƒ«é€ä¿¡
            msg = MIMEMultipart()
            msg['From'] = sender
            msg['To'] = ', '.join(recipients)
            msg['Subject'] = subject

            msg.attach(MIMEText(content, 'plain', 'utf-8'))

            server = smtplib.SMTP(smtp_server, smtp_port)
            server.starttls()
            server.login(username, password)
            server.sendmail(sender, recipients, msg.as_string())
            server.quit()

            self.logger.info(f'æœ€é©åŒ–ãƒ¬ãƒãƒ¼ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸ: {subject}')
            return True

        except Exception as e:
            self.logger.error(f'ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼: {e}')
            return False

    def _generate_email_content(self, weather_data, recommendation, battery_status,
                               battery_pattern, achievement, cost_savings):
        """ãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’ç”Ÿæˆ"""
        content = []

        # ãƒ˜ãƒƒãƒ€ãƒ¼
        content.append("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        content.append(" å¤©æ°—äºˆå ±ã¨ç™ºé›»äºˆæ¸¬ ")
        content.append("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        content.append("")

        # å¤©æ°—äºˆå ±
        content.append(f"ä»Šæ—¥:      {weather_data['today']['weather']}      æ°—æ¸©: æœ€é«˜{weather_data['today']['temp_max']}â„ƒ / æœ€ä½{weather_data['today']['temp_min']}â„ƒ")
        content.append(f"æ˜æ—¥:      {weather_data['tomorrow']['weather']}      æ°—æ¸©: æœ€é«˜{weather_data['tomorrow']['temp_max']}â„ƒ / æœ€ä½{weather_data['tomorrow']['temp_min']}â„ƒ")
        content.append(f"æ˜å¾Œæ—¥:      {weather_data['day_after']['weather']}      æ°—æ¸©: æœ€é«˜{weather_data['day_after']['temp_max']}â„ƒ / æœ€ä½{weather_data['day_after']['temp_min']}â„ƒ")
        content.append("")
        content.append(f"ç™ºé›»äºˆæ¸¬: {weather_data['generation_forecast']}")

        content.append("")
        content.append("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        content.append(" ä»Šæ—¥ã®æ¨å¥¨è¨­å®š ")
        content.append("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        content.append("")

        # æ¨å¥¨è¨­å®š
        if recommendation:
            settings = recommendation.get('settings', {})
            content.append("åŸºæœ¬è¨­å®šï¼ˆå­£ç¯€ï¼šæ˜¥ç§‹å­£ï¼‰")
            content.append(f"ID 07: {settings.get('ID07', 50)}A (åŸºæœ¬)")
            content.append(f"ID 10: {settings.get('ID10', 45)}åˆ† (åŸºæœ¬)")
            content.append(f"ID 41: {settings.get('ID41', '03:00')} (åŸºæœ¬)")
            content.append(f"ID 62: {settings.get('ID62', 45)}% (åŸºæœ¬)")
            content.append("")
            content.append("æ¨å¥¨å¤‰æ›´")
            content.append(f"ID 62: {settings.get('ID62', 45)} â†’ 35")
            content.append("ç†ç”±: é€šå¸¸è¨­å®šï¼ˆ4æœˆ-6æœˆ, 10æœˆ-11æœˆï¼‰")
        else:
            content.append("åŸºæœ¬è¨­å®šï¼ˆå­£ç¯€ï¼šæ˜¥ç§‹å­£ï¼‰")
            content.append("ID 07: 50A (åŸºæœ¬)")
            content.append("ID 10: 45åˆ† (åŸºæœ¬)")
            content.append("ID 41: 03:00 (åŸºæœ¬)")
            content.append("ID 62: 45% (åŸºæœ¬)")

        content.append("")
        content.append("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        content.append(" ç¾åœ¨ã®ãƒãƒƒãƒ†ãƒªãƒ¼çŠ¶æ³ ")
        content.append("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        content.append("")

        # ãƒãƒƒãƒ†ãƒªãƒ¼çŠ¶æ³
        if battery_status:
            content.append(f"ãƒãƒƒãƒ†ãƒªãƒ¼æ®‹é‡: {battery_status['soc']}% (å–å¾—æ™‚åˆ»: {battery_status['timestamp']})")
            content.append(f"é›»åœ§: {battery_status['voltage']}V")
            content.append(f"é›»æµ: {battery_status['current']}A")
        else:
            # å®Ÿéš›ã®ãƒãƒƒãƒ†ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            battery_status = self.get_current_battery_status()
            if battery_status:
                content.append(f"ãƒãƒƒãƒ†ãƒªãƒ¼æ®‹é‡: {battery_status['soc']}% (å–å¾—æ™‚åˆ»: {battery_status['timestamp']})")
                content.append(f"é›»åœ§: {battery_status['voltage']}V")
                content.append(f"é›»æµ: {battery_status['current']}A")
            else:
                content.append("ãƒãƒƒãƒ†ãƒªãƒ¼æ®‹é‡: ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...")
            if battery_status:
            content.append(f"é›»æµ: {battery_status['current']}A")
        else:
            content.append("é›»æµ: ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...")

        content.append("")
        content.append("24æ™‚é–“è“„é›»é‡å¤‰åŒ– (HTMLæ™‚ã¯ã‚°ãƒ©ãƒ•è¡¨ç¤º)")

        # 24æ™‚é–“ãƒ‘ã‚¿ãƒ¼ãƒ³è¡¨ç¤º
        for time_point, soc in battery_pattern.items():
            if soc is not None:
                bar = self.generate_progress_bar(soc)
                content.append(f"{bar} {time_point}   {soc}%")

        content.append("")
        content.append("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        content.append(" ä»Šæ—¥ã®é”æˆçŠ¶æ³ ")
        content.append("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        content.append("")

        # é”æˆçŠ¶æ³
        solar = achievement['solar_generation']
        battery = achievement['battery_efficiency']
        
        content.append(f"å¤ªé™½å…‰ç™ºé›»: {solar['current']}kWh / {solar['target']}kWh ({solar['percentage']:.1f}%) - {solar['rating']}")
        content.append(f"é€²æ—: {self.generate_progress_bar(solar['percentage'])} {solar['percentage']:.1f}%")
        content.append("")
        content.append(f"ãƒãƒƒãƒ†ãƒªãƒ¼åŠ¹ç‡: {battery['percentage']:.1f}% - {battery['rating']}")
        content.append(f"é€²æ—: {self.generate_progress_bar(battery['percentage'])} {battery['percentage']:.1f}%")

        content.append("")
        content.append("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        content.append("")
        
        # ğŸ’ Ultimate Battle: 1å¹´å‰æ¯”è¼ƒã‚·ã‚¹ãƒ†ãƒ ï¼ˆã“ã“ãŒæ–°æ©Ÿèƒ½ï¼ï¼‰
        content.append(self.generate_ultimate_battle_section())
        
        content.append("")
        content.append("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        content.append(" é›»æ°—ä»£ç¯€ç´„åŠ¹æœ ")
        content.append("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        content.append("")

        # ç¯€ç´„åŠ¹æœ
        content.append(f"ä»Šæ—¥ã®ç¯€ç´„: Â¥{cost_savings['daily']}")
        content.append(f"æœˆé–“äºˆæ¸¬: Â¥{cost_savings['monthly']:,}")
        content.append(f"å¹´é–“äºˆæ¸¬: Â¥{cost_savings['yearly']:,}")
        content.append("")
        content.append("å››å›½é›»åŠ›æ–™é‡‘ä½“ç³»åŸºæº–")
        content.append(f"ã‚°ãƒªãƒƒãƒ‰ä¾å­˜åº¦: {cost_savings['grid_reduction']}%å‰Šæ¸›")

        content.append("")
        content.append("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        content.append(" ä»Šæ—¥ã®ç·åˆè©•ä¾¡ ")
        content.append("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        content.append("")

        # ç·åˆè©•ä¾¡
        content.append("EXCELLENT ç´ æ™´ã‚‰ã—ã„ï¼å®Œç’§ãªä¸€æ—¥ã§ã—ãŸ")
        content.append("ç·åˆã‚¹ã‚³ã‚¢: 92.5ç‚¹")

        content.append("")
        content.append("--- HANAZONOã‚·ã‚¹ãƒ†ãƒ  è‡ªå‹•æœ€é©åŒ– ---")
        content.append("Enhanced Email System v2.2 + Revolutionary Battle System")

        return '\n'.join(content)

def test_email_system():
    """ãƒ¡ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆ"""
    print("ğŸ“§ Enhanced Email System v2.2 + Revolutionary Battle System ãƒ†ã‚¹ãƒˆé–‹å§‹")
    print("=" * 60)

    # è¨­å®šèª­ã¿è¾¼ã¿
    try:
        with open('settings.json', 'r', encoding='utf-8') as f:
            settings = json.load(f)
        email_config = settings.get('email', {})
    except Exception as e:
        print(f"âš ï¸ è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
        email_config = {}

    # ãƒ¡ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
    notifier = EnhancedEmailNotifier(email_config)

    # ãƒ†ã‚¹ãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡
    test_data = {"test": True}
    success = notifier.send_daily_report(test_data, test_mode=False)

    if success:
        print("\nâœ… Revolutionary Battle Systemçµ±åˆãƒ¡ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆå®Œäº†")
    else:
        print("\nâŒ ãƒ¡ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆå¤±æ•—")

if __name__ == "__main__":
    test_email_system()