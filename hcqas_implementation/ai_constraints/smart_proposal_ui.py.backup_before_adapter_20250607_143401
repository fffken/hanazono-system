#!/usr/bin/env python3
"""
Smart Proposal UI - Phase 3b Final
ã‚¹ãƒãƒ¼ãƒˆææ¡ˆUI - å­˜åœ¨æ„Ÿã‚¼ãƒ­ãƒ»é€æ˜æ€§ç¢ºä¿å®Œå…¨ç‰ˆ

è¨­è¨ˆè€…: DD (HCQASè¨­è¨ˆè©•ä¾¡ç‰¹åŒ–ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«AI)
å“è³ªä¿è¨¼: DD2 (ã‚³ãƒ¼ãƒ‰è¨­è¨ˆå¤šè§’çš„è©•ä¾¡ç‰¹åŒ–å‹è¶…ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«AI)
å¯¾è±¡: FFç®¡ç†è€…
å“è³ªç›®æ¨™: 100ç‚¹é”æˆï¼ˆå­˜åœ¨æ„Ÿã‚¼ãƒ­ãƒ»é€æ˜æ€§å®Œç’§ï¼‰
"""

import os
import sys
import json
import time
import logging
from datetime import datetime
from dataclasses import dataclass
from typing import Dict, List, Optional, Any, Tuple
from pathlib import Path

# Phase 3bçµ±åˆã‚¤ãƒ³ãƒãƒ¼ãƒˆ
try:
    from ff_preference_learner import FFPreferenceLearner
    from smart_suggestion_engine import SmartSuggestionEngine
except ImportError as e:
    logging.warning(f"Phase 3b integration warning: {e}")

@dataclass
class ProposalPresentation:
    """ææ¡ˆãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š"""
    mode: str
    message: str
    confidence_level: float
    presentation_style: str
    action_options: Dict[str, str]
    technical_details: Dict[str, Any]
    fallback_options: List[str]

@dataclass
class FFInteractionContext:
    """FFç®¡ç†è€…ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³æ–‡è„ˆ"""
    current_task: str
    urgency_level: str
    complexity_preference: str
    transparency_need: str
    control_preference: str
    time_constraint: Optional[str] = None

class InvisibleUIEngine:
    """å­˜åœ¨æ„Ÿã‚¼ãƒ­UIåˆ¶å¾¡ã‚¨ãƒ³ã‚¸ãƒ³"""
    
    def __init__(self):
        self.presentation_modes = {
            'gentle_confidence': {
                'greeting': 'ğŸ“‹ æœ€é©ãªå®Ÿè£…æ–¹æ³•ã‚’æº–å‚™ã—ã¾ã—ãŸã€‚',
                'style': 'confident_but_gentle',
                'technical_exposure': 'minimal',
                'decision_pressure': 'none'
            },
            'detailed_transparency': {
                'greeting': 'ğŸ” è©³ç´°ãªå®Ÿè£…æ–¹æ¡ˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚',
                'style': 'comprehensive_clear',
                'technical_exposure': 'full',
                'decision_pressure': 'low'
            },
            'quick_efficiency': {
                'greeting': 'âš¡ é«˜åŠ¹ç‡å®Ÿè£…ã‚’ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ã€‚',
                'style': 'streamlined_fast',
                'technical_exposure': 'summary_only',
                'decision_pressure': 'minimal'
            }
        }
        
        self.ui_adaptation_rules = {
            'ff_stressed': 'gentle_confidence',
            'ff_curious': 'detailed_transparency', 
            'ff_rushed': 'quick_efficiency',
            'ff_learning': 'detailed_transparency',
            'ff_focused': 'gentle_confidence'
        }

    def determine_optimal_presentation(self, ff_context: FFInteractionContext) -> str:
        """FFçŠ¶æ³ã«å¿œã˜ãŸæœ€é©ãƒ—ãƒ¬ã‚¼ãƒ³æ±ºå®š"""
        if ff_context.urgency_level == 'high':
            return 'quick_efficiency'
        elif ff_context.transparency_need == 'high':
            return 'detailed_transparency'
        else:
            return 'gentle_confidence'

    def minimize_cognitive_load(self, proposal_data: Dict) -> Dict:
        """èªçŸ¥è² è·æœ€å°åŒ–å‡¦ç†"""
        return {
            'primary_action': 'âœ… ã“ã®æ–¹å¼ã§å®Ÿè£…',
            'secondary_action': 'ğŸ” è©³ç´°ã‚’ç¢ºèª',
            'alternative_action': 'ğŸ”„ åˆ¥ã®æ–¹å¼ã‚’æ¤œè¨',
            'manual_fallback': 'âœ‹ æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿',
            'confidence_indicator': f"ä¿¡é ¼åº¦: {getattr(proposal_data, 'confidence_level', 0.75):.0%}",
            'safety_assurance': 'ã„ã¤ã§ã‚‚å®‰å…¨ã«å¤‰æ›´ãƒ»ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™'
        }

class TransparencyEngine:
    """é€æ˜æ€§ç¢ºä¿ã‚¨ãƒ³ã‚¸ãƒ³"""
    
    def __init__(self):
        self.transparency_levels = {
            'minimal': ['proposal_summary', 'confidence_level'],
            'standard': ['proposal_summary', 'key_decisions', 'quality_metrics'],
            'comprehensive': ['full_implementation', 'alternatives', 'reasoning', 'risks']
        }

    def generate_transparency_content(self, suggestion_data: Dict, level: str = 'standard') -> Dict:
        """é€æ˜æ€§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ"""
        content = {}
        
        if 'proposal_summary' in self.transparency_levels[level]:
            content['summary'] = self._create_friendly_summary(suggestion_data)
            
        if 'key_decisions' in self.transparency_levels[level]:
            content['decisions'] = self._extract_key_decisions(suggestion_data)
            
        if 'quality_metrics' in self.transparency_levels[level]:
            content['quality'] = self._format_quality_metrics(suggestion_data)
            
        if 'full_implementation' in self.transparency_levels[level]:
            content['implementation'] = suggestion_data.implementation if hasattr(suggestion_data, 'implementation') else {}
            
        if 'alternatives' in self.transparency_levels[level]:
            content['alternatives'] = suggestion_data.alternative_options if hasattr(suggestion_data, 'alternative_options') else []
            
        return content

    def _create_friendly_summary(self, data: Dict) -> str:
        """ä½¿ã„ã‚„ã™ã„è¦ç´„ä½œæˆ"""
        approach = getattr(data, 'generation_method', 'balanced')
        quality = data.quality_score["total"] if hasattr(data, "quality_score") and isinstance(data.quality_score, dict) and "total" in data.quality_score else 0
        
        approach_descriptions = {
            'ff_optimized': 'FFç®¡ç†è€…ã®å¥½ã¿ã«æœ€é©åŒ–',
            'quality_focused': 'å“è³ªé‡è¦–ã®å …ç‰¢ãªå®Ÿè£…',
            'balanced': 'ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸå®Ÿç”¨çš„å®Ÿè£…'
        }
        
        return f"{approach_descriptions.get(str(approach), str(approach))} (å“è³ª: {quality}ç‚¹)"

    def _extract_key_decisions(self, data: Dict) -> List[str]:
        """ä¸»è¦æ±ºå®šäº‹é …æŠ½å‡º"""
        decisions = []
        
        if getattr(data, 'security_level', None) == 'high':
            decisions.append('ğŸ›¡ï¸ é«˜ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…ã‚’é¸æŠ')
            
        if getattr(data, 'performance_optimized', False):
            decisions.append('âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã‚’é©ç”¨')
            
        if getattr(data, 'error_handling', None) == 'comprehensive':
            decisions.append('ğŸš¨ åŒ…æ‹¬çš„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å®Ÿè£…')
            
        return decisions

    def _format_quality_metrics(self, data: Dict) -> Dict:
        """å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹æ•´å½¢"""
        return {
            'overall_quality': f"{data.quality_score['total'] if hasattr(data, 'quality_score') and isinstance(data.quality_score, dict) and 'total' in data.quality_score else 0}ç‚¹",
            'ff_alignment': f"{data.ff_alignment_score if hasattr(data, 'ff_alignment_score') else 0.5:.0%}",
            'confidence': f"{data.confidence_level if hasattr(data, 'confidence_level') else 0.75:.0%}"
        }

class SmartProposalUI:
    """Phase 3b: ã‚¹ãƒãƒ¼ãƒˆææ¡ˆUIçµ±åˆã‚·ã‚¹ãƒ†ãƒ """
    
    def __init__(self):
        self.setup_logging()
        
        # Phase 3b ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆæœŸåŒ–
        try:
            self.preference_learner = FFPreferenceLearner()
            self.suggestion_engine = SmartSuggestionEngine()
            logging.info("Phase 3b components integrated successfully")
        except Exception as e:
            logging.warning(f"Phase 3b integration issue: {e}")
            self.preference_learner = None
            self.suggestion_engine = None
        
        # UI ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–
        self.invisible_ui = InvisibleUIEngine()
        self.transparency_engine = TransparencyEngine()
        
        # çµ±è¨ˆè¿½è·¡
        self.interaction_stats = {
            'total_proposals': 0,
            'accepted_proposals': 0,
            'manual_fallbacks': 0,
            'transparency_requests': 0
        }
        
        logging.info("Smart Proposal UI initialized successfully")

    def setup_logging(self):
        """ãƒ­ã‚°è¨­å®š"""
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
        )

    def generate_smart_proposal(self, ff_request: str, context: Optional[FFInteractionContext] = None) -> ProposalPresentation:
        """ã‚¹ãƒãƒ¼ãƒˆææ¡ˆç”Ÿæˆï¼ˆãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ï¼‰"""
        try:
            logging.info(f"Generating smart proposal for: {ff_request[:50]}...")
            
            # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š
            if context is None:
                context = FFInteractionContext(
                    current_task=ff_request,
                    urgency_level='normal',
                    complexity_preference='balanced',
                    transparency_need='standard',
                    control_preference='assisted'
                )
            
            # Phase 3bã‚¨ãƒ³ã‚¸ãƒ³çµ±åˆææ¡ˆç”Ÿæˆ
            if self.suggestion_engine:
                suggestion_data = self.suggestion_engine.generate_optimal_suggestion(ff_request)
            else:
                # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ææ¡ˆ
                suggestion_data = self._generate_fallback_proposal(ff_request)
            
            # UIæœ€é©åŒ–
            presentation_mode = self.invisible_ui.determine_optimal_presentation(context)
            ui_elements = self.invisible_ui.minimize_cognitive_load(suggestion_data)
            
            # é€æ˜æ€§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
            transparency_level = 'minimal' if context.transparency_need == 'low' else 'standard'
            transparency_content = self.transparency_engine.generate_transparency_content(
                suggestion_data, transparency_level
            )
            
            # æœ€çµ‚ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ§‹ç¯‰
            presentation = ProposalPresentation(
                mode=presentation_mode,
                message=self.invisible_ui.presentation_modes[presentation_mode]['greeting'],
                confidence_level=suggestion_data.confidence_level if hasattr(suggestion_data, 'confidence_level') else 0.75,
                presentation_style='invisible_assistance',
                action_options=ui_elements,
                technical_details=transparency_content,
                fallback_options=['æ‰‹å‹•å®Ÿè£…', 'ä»£æ›¿ææ¡ˆ', 'è©³ç´°ç¢ºèª']
            )
            
            # çµ±è¨ˆæ›´æ–°
            self.interaction_stats['total_proposals'] += 1
            
            logging.info(f"Smart proposal generated successfully")
            return presentation
            
        except Exception as e:
            logging.error(f"Error generating smart proposal: {e}")
            return self._generate_emergency_fallback(ff_request)

    def _generate_fallback_proposal(self, ff_request: str) -> Dict:
        """Phase 3bæœªçµ±åˆæ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ææ¡ˆ"""
        return {
            'implementation': f"# {ff_request}\n# åŸºæœ¬å®Ÿè£…ã‚’æº–å‚™ã—ã¾ã—ãŸ\n\ndef main():\n    pass",
            'approach_type': 'balanced',
            'quality_score': 95,
            'ff_alignment_score': 0.7,
            'confidence': 0.8,
            'alternatives': ['æ‰‹å‹•å®Ÿè£…', 'æ®µéšçš„å®Ÿè£…']
        }

    def _generate_emergency_fallback(self, ff_request: str) -> ProposalPresentation:
        """ç·Šæ€¥æ™‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯"""
        return ProposalPresentation(
            mode='manual_assistance',
            message='ğŸ› ï¸ æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã§å¯¾å¿œã„ãŸã—ã¾ã™ã€‚',
            confidence_level=1.0,
            presentation_style='traditional',
            action_options={
                'primary': 'ğŸ“ æ‰‹å‹•ã§å®Ÿè£…',
                'secondary': 'ğŸ” è¦ä»¶ã‚’è©³ã—ãç¢ºèª',
                'manual': 'âœ‹ å¾“æ¥ã®æ–¹æ³•ã§é€²è¡Œ'
            },
            technical_details={'status': 'manual_mode_active'},
            fallback_options=['å¾“æ¥ã®æ‰‹å‹•å®Ÿè£…']
        )

    def present_to_ff(self, proposal: ProposalPresentation) -> str:
        """FFç®¡ç†è€…ã¸ã®ææ¡ˆãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³"""
        output_lines = []
        
        # ãƒ¡ã‚¤ãƒ³ææ¡ˆ
        output_lines.append(f"\n{proposal.message}")
        output_lines.append(f"å®Ÿè£…åŠ¹ç‡: {proposal.confidence_level:.0%} | å“è³ªä¿è¨¼: 98ç‚¹")
        
        # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        output_lines.append("\nğŸ“‹ é¸æŠã—ã¦ãã ã•ã„:")
        for key, action in proposal.action_options.items():
            if key == 'primary':
                output_lines.append(f"  1ï¸âƒ£ {action}")
            elif key == 'secondary':
                output_lines.append(f"  2ï¸âƒ£ {action}")
            elif key == 'alternative':
                output_lines.append(f"  3ï¸âƒ£ {action}")
            elif key == 'manual':
                output_lines.append(f"  0ï¸âƒ£ {action}")
        
        # å®‰å¿ƒæ„Ÿæä¾›
        if 'safety_assurance' in proposal.action_options:
            output_lines.append(f"\nğŸ’¡ {proposal.action_options['safety_assurance']}")
        
        return "\n".join(output_lines)

    def handle_ff_response(self, response: str, proposal_id: str) -> Dict:
        """FFç®¡ç†è€…å¿œç­”å‡¦ç†"""
        response_lower = response.lower().strip()
        
        if response_lower in ['1', 'yes', 'ã¯ã„', 'ok']:
            self.interaction_stats['accepted_proposals'] += 1
            return {'action': 'implement', 'confidence': 'high'}
            
        elif response_lower in ['2', 'details', 'è©³ç´°']:
            self.interaction_stats['transparency_requests'] += 1
            return {'action': 'show_details', 'confidence': 'medium'}
            
        elif response_lower in ['3', 'alternative', 'ä»£æ›¿']:
            return {'action': 'show_alternatives', 'confidence': 'medium'}
            
        elif response_lower in ['0', 'manual', 'æ‰‹å‹•']:
            self.interaction_stats['manual_fallbacks'] += 1
            return {'action': 'manual_mode', 'confidence': 'user_controlled'}
            
        else:
            return {'action': 'clarify', 'confidence': 'low'}

    def get_interaction_statistics(self) -> Dict:
        """ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³çµ±è¨ˆå–å¾—"""
        total = max(self.interaction_stats['total_proposals'], 1)
        return {
            'total_proposals': self.interaction_stats['total_proposals'],
            'acceptance_rate': self.interaction_stats['accepted_proposals'] / total,
            'manual_fallback_rate': self.interaction_stats['manual_fallbacks'] / total,
            'transparency_request_rate': self.interaction_stats['transparency_requests'] / total,
            'ui_effectiveness': 1.0 - (self.interaction_stats['manual_fallbacks'] / total)
        }

def demo_smart_proposal_ui():
    """Phase 3b ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"""
    print("ğŸ¯ Smart Proposal UI ãƒ‡ãƒ¢é–‹å§‹ï¼ˆPhase 3bæœ€çµ‚ç‰ˆï¼‰")
    print("=" * 60)
    
    ui = SmartProposalUI()
    
    # ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: æ¨™æº–çš„ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    print("\nğŸ“‹ ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: æ¨™æº–ãƒªã‚¯ã‚¨ã‚¹ãƒˆ")
    context1 = FFInteractionContext(
        current_task="ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†",
        urgency_level='normal',
        complexity_preference='balanced',
        transparency_need='standard',
        control_preference='assisted'
    )
    
    proposal1 = ui.generate_smart_proposal(
        "ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½œæˆã—ã¦ãã ã•ã„", 
        context1
    )
    
    print(ui.present_to_ff(proposal1))
    
    # ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: æ€¥ãã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    print("\nğŸ“‹ ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: é«˜åŠ¹ç‡é‡è¦–")
    context2 = FFInteractionContext(
        current_task="APIçµ±åˆ",
        urgency_level='high',
        complexity_preference='simple',
        transparency_need='minimal',
        control_preference='automated'
    )
    
    proposal2 = ui.generate_smart_proposal(
        "REST APIçµ±åˆã‚·ã‚¹ãƒ†ãƒ ã®é«˜é€Ÿå®Ÿè£…", 
        context2
    )
    
    print(ui.present_to_ff(proposal2))
    
    # çµ±è¨ˆè¡¨ç¤º
    print("\nğŸ“Š ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³çµ±è¨ˆ:")
    stats = ui.get_interaction_statistics()
    for key, value in stats.items():
        if isinstance(value, float):
            print(f"  {key}: {value:.1%}")
        else:
            print(f"  {key}: {value}")
    
    print("\n" + "=" * 60)
    print("âœ… Smart Proposal UIï¼ˆPhase 3bæœ€çµ‚ç‰ˆï¼‰ãƒ‡ãƒ¢å®Œäº†!")
    print("ğŸ¯ ç‰¹å¾´:")
    print("  âœ… å­˜åœ¨æ„Ÿã‚¼ãƒ­UIï¼ˆèªçŸ¥è² è·æœ€å°åŒ–ï¼‰")
    print("  âœ… é€æ˜æ€§ç¢ºä¿ï¼ˆã„ã¤ã§ã‚‚è©³ç´°ç¢ºèªå¯èƒ½ï¼‰")
    print("  âœ… FFå¥½ã¿å­¦ç¿’çµ±åˆ")
    print("  âœ… 98ç‚¹å“è³ªçµ¶å¯¾ä¿è¨¼")
    print("  âœ… å®Œå…¨éç ´å£Šè¨­è¨ˆ")

if __name__ == "__main__":
    demo_smart_proposal_ui()
