# Enhanced Email System v2.0 完全仕様書
**作成日**: 2025-05-25 11:00
**目標**: 13:39レベル高機能メール復活 + 人間vsAI最適化バトル

## 🎯 核心ミッション
- **目的**: 電気料金削減の自動最適化
- **哲学**: 感覚的に情報を捉えられるデザイン
- **継続性**: スコア化による継続モチベーション

## 📧 メール構造（確定版）
HANAZONOシステム 最適化レポート 2025年05月25日 11:00

🌤️ 天気予報と発電予測

絵文字表示: ☀️ → ☁️
気温表示
発電予測レベル
気象警報・注意報（該当時）
🔋 今日の推奨設定（人間 vs AI対戦） ┌─ 📚 設定ガイド推奨（人間の知恵）─┐ │ ID07: 50A ID10: 45分 ID62: 45% │ │ 理由: 春季標準設定 │ │ 信頼度: ⭐⭐⭐⭐⭐ │ └─────────────────────────────┘

┌─ 🤖 AI推奨（機械学習）──────────┐ │ ID07: 48A ID10: 42分 ID62: 43% │ │ 理由: 過去30日実績分析 │ │ 信頼度: ⭐⭐⭐⚪⚪ │ │ 予測節約: +¥23/日 │ └─────────────────────────────┘

🔋 現在のバッテリー状況

SOC%, 電圧, 電流（Modbusレジスタ活用）
取得時刻表示
🎯 今日の達成状況

太陽光発電効率
バッテリー効率
視覚的バーグラフ
💰 電気代節約効果

今日/月間/年間予測
四国電力料金体系基準
📊 今日の総合評価

🏆PERFECT等のスコア表示
🔥 人間 vs AI 対戦成績

日次勝敗
月間ランキング
累積差額

## 🎨 メールタイトル絵文字ルール
**季節設定継続**:
- 🌻 夏季設定
- 🍂 秋季設定  
- ❄️ 冬季設定
- 🌸 春季設定

**変更推奨**:
- 🟡 晴天用設定
- 🔵 雨用設定
- 🟣 曇天用設定
- ⚫️ 台風用設定
- 🔴 緊急用設定

## 🏗️ システムアーキテクチャ
enhanced_email_system_v2/ ├── core/ │ ├── design_principles.py # 絶対不変の設計思想 │ ├── report_structure.py # 基本レポート構造 │ └── modbus_interface.py # レジスタデータ活用 ├── modules/ │ ├── weather_analyzer.py # 天気予報分析 │ ├── settings_optimizer.py # 設定最適化 │ ├── cost_calculator.py # 節約効果計算 │ ├── ai_learning_engine.py # 機械学習エンジン │ └── battle_system.py # 人間vsAI対戦 ├── templates/ │ ├── html_templates.py # HTMLデザイン │ └── email_formats.py # メール形式 ├── data/ │ ├── daily_performance.db # 日次実績データ │ ├── ai_decisions.db # AI判断履歴 │ ├── battle_results.db # 対戦成績 │ └── system_metrics.db # システム指標 └── config/ ├── settings_guide_cache.py # 設定ガイド月次更新 └── update_manager.py # 自動更新管理


## 🤖 AI学習エンジン仕様

### Phase 1: 観察学習期（0-3ヶ月）
- 設定ガイドの決定パターン学習
- 天気→設定変更の相関分析
- 実績データとの因果関係学習

### Phase 2: 挑戦期（3-6ヶ月）
- 微調整提案（±5%以内）
- A/Bテスト的比較実験
- リスク最小化学習

### Phase 3: 進化期（6ヶ月以降）
- 天気予報精度考慮最適化
- 季節変化先読み最適化
- 個別環境特性適応

## 📊 Modbusレジスタ活用
**使用レジスタ（LVYUAN SPI-10K-U）**:
- 0x0007: バッテリー電圧（10倍値）
- 0x0008: バッテリー電流（±）
- 0x000E: バッテリー残量（SOC）
- 0x0006: PV合計出力
- 0x000D: ヒートシンク温度

## 🛡️ AI安全装置
```python
# 設定値制限ルール
SAFETY_LIMITS = {
    'ID07': {'min': 20, 'max': 80},  # 充電電流 20-80A
    'ID10': {'min': 10, 'max': 90},  # 充電時間 10-90分
    'ID62': {'min': 20, 'max': 80}   # SOC設定 20-80%
}

# 緊急停止条件
- 連続3日AI敗北 → 人間設定強制
- 設定値が安全範囲外 → 即座に拒否
- 節約額マイナス → 設定ガイド復帰
🏆 勝敗判定KPI
節約額: ¥/日での比較（重み40%）
効率性: バッテリー利用効率%（重み30%）
安定性: 設定変更頻度ペナルティ（重み20%）
予測精度: 天気予報的中率考慮（重み10%）
🔄 更新・保守ルール
月次更新
設定ガイドURL確認・更新
AI学習データ分析
対戦成績集計
緊急更新
設定ガイド変更時の手動通知
システムエラー時のフォールバック
自動化項目
天気API失敗→シンプルメール送信
設定ガイド取得失敗→キャッシュ版使用
AI計算失敗→ルールベース設定
バックアップ戦略
毎日23:59に学習データバックアップ
週次で設定ガイドキャッシュ更新
月次で全システムスナップショット
🎮 ゲーミフィケーション要素
対戦ルール
同じ条件での公平比較
AI敗北時の理由分析表示
ユーザーは「人間チーム」応援者
特別イベント
月末「AIチャレンジウィーク」
季節変わり目「大決戦」
年末「年間王者決定戦」
🚨 絶対に守るべき原則
設計思想（不変）
電気料金削減が最優先
感覚的UI/UX重視
継続モチベーション維持
確実な前進、絶対に後退なし
開発原則
モジュール分離による堅牢性
段階的機能追加
完全自動化指向
詳細なログ・記録
🧪 テスト戦略
Copy# 開発テスト手順
1. ドライラン: python3 test_email_dry_run.py
2. 安全テスト: python3 test_safety_limits.py  
3. 統合テスト: python3 test_full_system.py
4. 本番投入: python3 deploy_with_rollback.py
📞 緊急時対応
天気API失敗: 基本メール送信
全システム失敗: フォールバックメール
AI暴走: 人間設定強制採用
🔗 重要URL
設定ガイド: https://raw.githubusercontent.com/fffken/hanazono-system/refs/heads/main/docs/HANAZONO-SYSTEM-SETTINGS.md
ロードマップ: https://raw.githubusercontent.com/fffken/hanazono-system/refs/heads/main/docs/ROADMAP_COMPLETE.md
✅ 実装チェックリスト
 基本レポート構造
 人間vs AI対戦表示
 Modbusデータ取得
 天気予報連携
 HTML美化
 AI学習基盤
 月次レポート
 完全自動化
重要: この仕様書は絶対に変更・削除してはいけません。 アップデート時は必ずこの仕様書を参照し、設計思想を維持してください。 補強完了: 2025-05-25 12:30

## ⚡ 超効率開発原則

### 🎯 開発効率最優先ルール
**開発コスト = 時間 × 労力 × 複雑度**
- 開発時間の短縮が最優先
- 頭を使わない自動化重視
- 手間を最小化する設計

### 🚀 実装戦略
```python
# 効率化優先順位
1. コピペ可能なテンプレート活用
2. 既存コード最大限再利用
3. 自動生成ツール優先使用
4. 手動作業は絶対最小限
🛠️ 開発手法
原則: 考えるな、コピペしろ、動かせ

テンプレート駆動開発: 全てテンプレート化
設定ファイル外部化: コード変更なしで機能変更
自動テスト: 手動確認作業ゼロ
ワンコマンド実行: 複雑な手順は自動化
📋 効率化チェックリスト
 新規コード < 既存コード再利用
 手動設定 < 自動検出・設定
 複雑ロジック < シンプル分岐
 長時間開発 < 短時間リリース
🔧 自動化必須項目
Copy# 全て自動化対象
- コード生成: auto_generate_modules.py
- テスト実行: auto_test_all.py  
- デプロイ: auto_deploy.py
- バックアップ: auto_backup.py
- 監視: auto_monitor.py
💡 開発時間短縮テクニック
既存パターン流用: 新規作成禁止、既存改造優先
設定駆動: ハードコード禁止、全て設定ファイル化
エラー時自動修復: 人間判断不要の自動回復
ログ自動解析: 問題自動検出・通知
効率化原則追加: 2025-05-25 12:35 開発方針: 最小工数で最大効果、思考時間ゼロ、手間ゼロ実装

```bash
nano ENHANCED_EMAIL_SYSTEM_V2_SPECIFICATION.md
