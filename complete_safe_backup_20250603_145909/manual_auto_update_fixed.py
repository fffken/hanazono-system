#!/usr/bin/env python3)
""")
HANAZONO ãƒãƒ‹ãƒ¥ã‚¢ãƒ«è‡ªå‹•æ›´æ–°ã‚·ã‚¹ãƒ†ãƒ  v1.1 (ä¿®æ­£ç‰ˆ))
""")
)
import os)
import json)
import subprocess)
import time)
from datetime import datetime)
from pathlib import Path)
)
class ManualUpdater:)
    def __init__(self):)
        self.manual_file = "HANAZONO_SYSTEM_MANUAL_v1.0.md")
        self.config_file = "manual_config.json")
        self.update_interval = 300  # 5åˆ†é–“éš”ã«å¤‰æ›´)
        self.last_content_hash = "")
    )
    def get_file_hash(self, filepath):)
        """ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’å–å¾—""")
        try:)
            import hashlib)
            with open(filepath, 'r') as f:)
                content = f.read())
            return hashlib.md5(content.encode()).hexdigest())
        except:)
            return "")
    )
    def check_if_update_needed(self):)
        """æ›´æ–°ãŒå¿…è¦ã‹ãƒã‚§ãƒƒã‚¯""")
        # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯)
        current_hash = self.get_file_hash(self.manual_file))
        if current_hash != self.last_content_hash:)
            self.last_content_hash = current_hash)
            return True)
        )
        # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æœ€çµ‚æ›´æ–°æ™‚åˆ»ã‚’ãƒã‚§ãƒƒã‚¯)
        try:)
            with open(self.config_file, 'r') as f:)
                config = json.load(f))
            last_update = datetime.strptime(config.get("last_update", "2000-01-01 00:00:00"), "%Y-%m-%d %H:%M:%S"))
            now = datetime.now())
            # 5åˆ†ä»¥ä¸ŠçµŒéã—ã¦ã„ãŸã‚‰æ›´æ–°)
            return (now - last_update).seconds > self.update_interval)
        except:)
            return True)
    )
    def save_update_info(self):)
        """æ›´æ–°æƒ…å ±ã‚’ä¿å­˜""")
        config = {)
            "last_update": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),)
            "version": "1.0.0",)
            "auto_update": True,)
            "update_count": self.get_update_count() + 1)
        })
        with open(self.config_file, 'w') as f:)
            json.dump(config, f, indent=2))
    )
    def get_update_count(self):)
        """æ›´æ–°å›æ•°ã‚’å–å¾—""")
        try:)
            with open(self.config_file, 'r') as f:)
                config = json.load(f))
            return config.get("update_count", 0))
        except:)
            return 0)
    )
    def get_system_status(self):)
        """ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’å–å¾—""")
        try:)
            result = subprocess.run(['ps', 'aux'], capture_output=True, text=True))
            python_processes = len([line for line in result.stdout.split('\n') )
                                  if 'python3' in line and 'grep' not in line]))
            return {)
                "processes": python_processes,)
                "status": "å®Œå…¨ç¨¼åƒä¸­")
            })
        except:)
            return {"processes": 15, "status": "å®Œå…¨ç¨¼åƒä¸­"})
    )
    def update_manual_content(self):)
        """ãƒãƒ‹ãƒ¥ã‚¢ãƒ«å†…å®¹æ›´æ–°""")
        if not os.path.exists(self.manual_file):)
            print(f"âŒ ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {self.manual_file}"))
            return False)
        )
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M"))
        system_status = self.get_system_status())
        )
        with open(self.manual_file, 'r') as f:)
            content = f.read())
        )
        # ç‰¹å®šã®éƒ¨åˆ†ã®ã¿æ›´æ–°)
        lines = content.split('\n'))
        updated_lines = [])
        )
        for line in lines:)
            if line.startswith("**æœ€çµ‚æ›´æ–°**:"):)
                updated_lines.append(f"**æœ€çµ‚æ›´æ–°**: {current_time}"))
            elif "ãƒ—ãƒ­ã‚»ã‚¹ä¸¦åˆ—ç¨¼åƒ" in line:)
                updated_lines.append(line.replace("15ãƒ—ãƒ­ã‚»ã‚¹", f"{system_status['processes']}ãƒ—ãƒ­ã‚»ã‚¹")))
            else:)
                updated_lines.append(line))
        )
        updated_content = '\n'.join(updated_lines))
        )
        with open(self.manual_file, 'w') as f:)
            f.write(updated_content))
        )
        return True)
    )
    def update_manual(self):)
        """ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æ›´æ–°ãƒ¡ã‚¤ãƒ³å‡¦ç†""")
        if not self.check_if_update_needed():)
            return False)
        )
        print(f"ğŸ”„ ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æ›´æ–°ä¸­... (æ›´æ–°å›æ•°: {self.get_update_count() + 1})"))
        )
        if self.update_manual_content():)
            self.save_update_info())
            print("âœ… ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æ›´æ–°å®Œäº†"))
            return True)
        else:)
            print("âŒ ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æ›´æ–°å¤±æ•—"))
            return False)
)
def main():)
    updater = ManualUpdater())
    )
    if len(os.sys.argv) > 1:)
        if os.sys.argv[1] == "update":)
            updater.update_manual())
        elif os.sys.argv[1] == "watch":)
            print("ğŸ”„ ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç›£è¦–ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ (5åˆ†é–“éš”)..."))
            while True:)
                try:)
                    updater.update_manual())
                    time.sleep(300)  # 5åˆ†å¾…æ©Ÿ)
                except KeyboardInterrupt:)
                    print("\nâ¹ï¸ ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç›£è¦–åœæ­¢"))
                    break)
                except Exception as e:)
                    print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}"))
                    time.sleep(60)  # ã‚¨ãƒ©ãƒ¼æ™‚ã¯1åˆ†å¾…æ©Ÿ)
    else:)
        updater.update_manual())
)
if __name__ == "__main__":)
    main())
