#!/usr/bin/env python3)
# -*- coding: utf-8 -*-)
""")
HANAZONOã‚·ã‚¹ãƒ†ãƒ  é©æ–°çš„5æ®µéšãƒãƒˆãƒ«ã‚·ã‚¹ãƒ†ãƒ  v1.0)
6å¹´é–“ã®é€²åŒ–ã‚’5æ®µéšã«åˆ†ã‘ãŸå²ä¸Šæœ€å¼·ã®ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³)
)
Battle Types:)
1. ğŸ¥‰ Historic Battle: éå»vséå»ï¼ˆæ”¹å–„åŠªåŠ›åŠ¹æœï¼‰)
2. ğŸ¥ˆ Evolution Battle: ãƒ•ã‚§ãƒ¼ã‚ºé–“æ¯”è¼ƒï¼ˆæ™‚ä»£å¤‰åŒ–åŠ¹æœï¼‰)
3. ğŸ¥‡ Optimization Battle: åŒãƒ•ã‚§ãƒ¼ã‚ºå†…æœ€é©åŒ–)
4. ğŸ’ Ultimate Battle: HANAZONOã‚·ã‚¹ãƒ†ãƒ åŠ¹æœ)
5. ğŸ† Legendary Battle: å…¨æœŸé–“çµ±åˆãƒãƒˆãƒ«)
""")
)
import sqlite3)
import json)
from datetime import datetime, timedelta)
from typing import Dict, List, Optional, Tuple)
import logging)
)
class RevolutionaryBattleSystem:)
    """é©æ–°çš„5æ®µéšãƒãƒˆãƒ«ã‚·ã‚¹ãƒ†ãƒ """)
    )
    def __init__(self, db_path="data/comprehensive_electric_data.db"):)
        self.db_path = db_path)
        self.logger = self.setup_logger())
        )
        # ãƒãƒˆãƒ«ã‚¿ã‚¤ãƒ—å®šç¾©)
        self.battle_types = {)
            "historic": {)
                "name": "ğŸ¥‰ Historic Battle",)
                "description": "éå»åŒå£«ã®æ¯”è¼ƒï¼ˆäººé–“ã®æ”¹å–„åŠªåŠ›åŠ¹æœï¼‰",)
                "emoji": "ğŸ¥‰",)
                "difficulty": 1)
            },)
            "evolution": {)
                "name": "ğŸ¥ˆ Evolution Battle", )
                "description": "ãƒ•ã‚§ãƒ¼ã‚ºé–“å¤‰åŒ–ï¼ˆæ™‚ä»£ãƒ»ç’°å¢ƒå¤‰åŒ–åŠ¹æœï¼‰",)
                "emoji": "ğŸ¥ˆ",)
                "difficulty": 2)
            },)
            "optimization": {)
                "name": "ğŸ¥‡ Optimization Battle",)
                "description": "åŒãƒ•ã‚§ãƒ¼ã‚ºå†…æœ€é©åŒ–ï¼ˆå­¦ç¿’åŠ¹æœï¼‰",)
                "emoji": "ğŸ¥‡", )
                "difficulty": 3)
            },)
            "ultimate": {)
                "name": "ğŸ’ Ultimate Battle",)
                "description": "HANAZONOã‚·ã‚¹ãƒ†ãƒ åŠ¹æœï¼ˆæŠ€è¡“é©æ–°åŠ¹æœï¼‰",)
                "emoji": "ğŸ’",)
                "difficulty": 4)
            },)
            "legendary": {)
                "name": "ğŸ† Legendary Battle",)
                "description": "å…¨æœŸé–“çµ±åˆãƒãƒˆãƒ«ï¼ˆç·åˆé€²åŒ–åŠ¹æœï¼‰",)
                "emoji": "ğŸ†",)
                "difficulty": 5)
            })
        })
        )
        # å®Ÿç¸¾ã‚·ã‚¹ãƒ†ãƒ å®šç¾©)
        self.achievements = {)
            "first_victory": {"name": "åˆå‹åˆ©", "description": "åˆã‚ã¦ã®ãƒãƒˆãƒ«å‹åˆ©", "emoji": "ğŸ‰"},)
            "winning_streak_5": {"name": "é€£å‹è¨˜éŒ²", "description": "5é€£å‹é”æˆ", "emoji": "ğŸ”¥"},)
            "phase_conqueror": {"name": "ãƒ•ã‚§ãƒ¼ã‚ºåˆ¶è¦‡", "description": "å…¨ãƒ•ã‚§ãƒ¼ã‚ºã§å‹åˆ©", "emoji": "ğŸ‘‘"},)
            "efficiency_master": {"name": "åŠ¹ç‡ãƒã‚¹ã‚¿ãƒ¼", "description": "50%ä»¥ä¸Šå‰Šæ¸›é”æˆ", "emoji": "âš¡"},)
            "legendary_champion": {"name": "ä¼èª¬ã®ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³", "description": "å…¨ãƒãƒˆãƒ«ã‚¿ã‚¤ãƒ—ã§å‹åˆ©", "emoji": "ğŸŒŸ"},)
            "diamond_achiever": {"name": "ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰åˆ°é”", "description": "ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰ãƒ©ãƒ³ã‚¯åˆ°é”", "emoji": "ğŸ’"},)
            "hanazono_hero": {"name": "HANAZONOãƒ’ãƒ¼ãƒ­ãƒ¼", "description": "å¹´é–“Â¥50,000å‰Šæ¸›é”æˆ", "emoji": "ğŸ¦¸"})
        })
    )
    def setup_logger(self):)
        """ãƒ­ã‚¬ãƒ¼è¨­å®š""")
        logger = logging.getLogger('RevolutionaryBattleSystem'))
        logger.setLevel(logging.INFO))
        )
        if not logger.handlers:)
            handler = logging.FileHandler('logs/battle_system.log'))
            formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s'))
            handler.setFormatter(formatter))
            logger.addHandler(handler))
        )
        return logger)
    )
    def historic_battle(self, year1: int, month1: int, year2: int, month2: int) -> Dict:)
        """ğŸ¥‰ Historic Battle: éå»åŒå£«ã®æ¯”è¼ƒ""")
        with sqlite3.connect(self.db_path) as conn:)
            cursor = conn.cursor())
            )
            # ä¸¡æ–¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—)
            cursor.execute(''')
                SELECT usage_kwh, cost_yen, phase FROM comprehensive_monthly)
                WHERE year = ? AND month = ?)
            ''', (year1, month1)))
            data1 = cursor.fetchone())
            )
            cursor.execute(''')
                SELECT usage_kwh, cost_yen, phase FROM comprehensive_monthly  )
                WHERE year = ? AND month = ?)
            ''', (year2, month2)))
            data2 = cursor.fetchone())
            )
            if not data1 or not data2:)
                return {"error": "ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™"})
            )
            usage1, cost1, phase1 = data1)
            usage2, cost2, phase2 = data2)
            )
            # ãƒãƒˆãƒ«çµæœè¨ˆç®—)
            usage_improvement = ((usage1 - usage2) / usage1) * 100)
            cost_improvement = ((cost1 - cost2) / cost1) * 100 if cost1 and cost2 else 0)
            )
            winner = "æœŸé–“2" if usage_improvement > 0 else "æœŸé–“1")
            )
            return {)
                "battle_type": "historic",)
                "period1": f"{year1}å¹´{month1}æœˆ ({phase1}æœŸ)",)
                "period2": f"{year2}å¹´{month2}æœˆ ({phase2}æœŸ)",)
                "usage1": usage1,)
                "usage2": usage2,)
                "cost1": cost1,)
                "cost2": cost2,)
                "usage_improvement": usage_improvement,)
                "cost_improvement": cost_improvement,)
                "winner": winner,)
                "result_emoji": "ğŸ†" if usage_improvement > 0 else "ğŸ’”",)
                "battle_summary": f"{year1}å¹´{month1}æœˆ vs {year2}å¹´{month2}æœˆ: {abs(usage_improvement):.1f}%{'æ”¹å–„' if usage_improvement > 0 else 'æ‚ªåŒ–'}")
            })
    )
    def evolution_battle(self, phase1: str, phase2: str) -> Dict:)
        """ğŸ¥ˆ Evolution Battle: ãƒ•ã‚§ãƒ¼ã‚ºé–“æ¯”è¼ƒ""")
        with sqlite3.connect(self.db_path) as conn:)
            cursor = conn.cursor())
            )
            # å„ãƒ•ã‚§ãƒ¼ã‚ºã®å¹³å‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—)
            cursor.execute(''')
                SELECT AVG(usage_kwh), AVG(cost_yen), COUNT(*) FROM comprehensive_monthly)
                WHERE phase = ? AND usage_kwh > 0)
            ''', (phase1,)))
            data1 = cursor.fetchone())
            )
            cursor.execute(''')
                SELECT AVG(usage_kwh), AVG(cost_yen), COUNT(*) FROM comprehensive_monthly)
                WHERE phase = ? AND usage_kwh > 0  )
            ''', (phase2,)))
            data2 = cursor.fetchone())
            )
            if not data1[0] or not data2[0]:)
                return {"error": "ãƒ•ã‚§ãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™"})
            )
            avg_usage1, avg_cost1, months1 = data1)
            avg_usage2, avg_cost2, months2 = data2)
            )
            # æ”¹å–„ç‡è¨ˆç®—)
            usage_evolution = ((avg_usage1 - avg_usage2) / avg_usage1) * 100)
            cost_evolution = ((avg_cost1 - avg_cost2) / avg_cost1) * 100 if avg_cost1 and avg_cost2 else 0)
            )
            return {)
                "battle_type": "evolution",)
                "phase1": phase1,)
                "phase2": phase2,)
                "avg_usage1": avg_usage1,)
                "avg_usage2": avg_usage2,)
                "avg_cost1": avg_cost1,)
                "avg_cost2": avg_cost2,)
                "months1": months1,)
                "months2": months2,)
                "usage_evolution": usage_evolution,)
                "cost_evolution": cost_evolution,)
                "winner": phase2 if usage_evolution > 0 else phase1,)
                "evolution_summary": f"{phase1}æœŸ â†’ {phase2}æœŸ: {abs(usage_evolution):.1f}%{'é€²åŒ–' if usage_evolution > 0 else 'é€€åŒ–'}")
            })
    )
    def ultimate_battle(self, year: int, month: int) -> Dict:)
        """ğŸ’ Ultimate Battle: HANAZONOã‚·ã‚¹ãƒ†ãƒ åŠ¹æœ""")
        # å‰å¹´åŒæœˆã¨ã®æ¯”è¼ƒï¼ˆHANAZONOã‚·ã‚¹ãƒ†ãƒ åŠ¹æœï¼‰)
        with sqlite3.connect(self.db_path) as conn:)
            cursor = conn.cursor())
            )
            # HANAZONOã‚·ã‚¹ãƒ†ãƒ å°å…¥å¾Œãƒ‡ãƒ¼ã‚¿)
            cursor.execute(''')
                SELECT usage_kwh, cost_yen FROM comprehensive_monthly)
                WHERE year = ? AND month = ? AND phase = 'hanazono')
            ''', (year, month)))
            hanazono_data = cursor.fetchone())
            )
            # å‰å¹´åŒæœˆãƒ‡ãƒ¼ã‚¿ï¼ˆpre_hanazonoæœŸï¼‰)
            cursor.execute(''')
                SELECT usage_kwh, cost_yen FROM comprehensive_monthly)
                WHERE year = ? AND month = ? AND phase != 'hanazono')
                ORDER BY year DESC LIMIT 1)
            ''', (year - 1, month)))
            pre_data = cursor.fetchone())
            )
            if not hanazono_data or not pre_data:)
                return {"error": "æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™"})
            )
            hanazono_usage, hanazono_cost = hanazono_data)
            pre_usage, pre_cost = pre_data)
            )
            # HANAZONOã‚·ã‚¹ãƒ†ãƒ åŠ¹æœè¨ˆç®—)
            hanazono_effect = ((pre_usage - hanazono_usage) / pre_usage) * 100)
            cost_effect = ((pre_cost - hanazono_cost) / pre_cost) * 100 if pre_cost and hanazono_cost else 0)
            )
            # ãƒ©ãƒ³ã‚¯åˆ¤å®š)
            if hanazono_effect >= 50:)
                rank = "ğŸ’ ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰")
            elif hanazono_effect >= 35:)
                rank = "ğŸ† ãƒ—ãƒ©ãƒãƒŠ")
            elif hanazono_effect >= 25:)
                rank = "ğŸ¥‡ ã‚´ãƒ¼ãƒ«ãƒ‰")
            elif hanazono_effect >= 15:)
                rank = "ğŸ¥ˆ ã‚·ãƒ«ãƒãƒ¼")
            elif hanazono_effect >= 5:)
                rank = "ğŸ¥‰ ãƒ–ãƒ­ãƒ³ã‚º")
            else:)
                rank = "ğŸ“‰ ãƒãƒ£ãƒ¬ãƒ³ã‚¸")
            )
            return {)
                "battle_type": "ultimate",)
                "hanazono_usage": hanazono_usage,)
                "pre_usage": pre_usage,)
                "hanazono_cost": hanazono_cost,)
                "pre_cost": pre_cost,)
                "hanazono_effect": hanazono_effect,)
                "cost_effect": cost_effect,)
                "rank": rank,)
                "victory": hanazono_effect > 0,)
                "ultimate_summary": f"HANAZONOã‚·ã‚¹ãƒ†ãƒ åŠ¹æœ: {hanazono_effect:.1f}%å‰Šæ¸› ({rank})")
            })
    )
    def legendary_battle(self) -> Dict:)
        """ğŸ† Legendary Battle: å…¨æœŸé–“çµ±åˆãƒãƒˆãƒ«""")
        with sqlite3.connect(self.db_path) as conn:)
            cursor = conn.cursor())
            )
            # å…¨ãƒ•ã‚§ãƒ¼ã‚ºã®çµ±è¨ˆã‚’å–å¾—)
            cursor.execute(''')
                SELECT phase, )
                       AVG(usage_kwh) as avg_usage,)
                       AVG(cost_yen) as avg_cost,)
                       COUNT(*) as months,)
                       MIN(year) as start_year,)
                       MAX(year) as end_year)
                FROM comprehensive_monthly )
                WHERE usage_kwh > 0)
                GROUP BY phase)
                ORDER BY MIN(year), MIN(month))
            ''', ()))
            )
            phases_data = cursor.fetchall())
            )
            if len(phases_data) < 2:)
                return {"error": "æ¯”è¼ƒå¯èƒ½ãªãƒ•ã‚§ãƒ¼ã‚ºãŒä¸è¶³ã—ã¦ã„ã¾ã™"})
            )
            # æœ€åˆã®ãƒ•ã‚§ãƒ¼ã‚ºã¨æœ€æ–°ã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’æ¯”è¼ƒ)
            first_phase = phases_data[0])
            latest_phase = phases_data[-1])
            )
            first_usage = first_phase[1])
            latest_usage = latest_phase[1])
            )
            # å…¨æœŸé–“é€²åŒ–ç‡)
            total_evolution = ((first_usage - latest_usage) / first_usage) * 100)
            )
            # å„ãƒ•ã‚§ãƒ¼ã‚ºã®æ”¹å–„ç‡ã‚’è¨ˆç®—)
            phase_improvements = [])
            for i in range(1, len(phases_data)):)
                prev_usage = phases_data[i-1][1])
                curr_usage = phases_data[i][1])
                improvement = ((prev_usage - curr_usage) / prev_usage) * 100)
                phase_improvements.append({)
                    "from_phase": phases_data[i-1][0],)
                    "to_phase": phases_data[i][0],)
                    "improvement": improvement)
                }))
            )
            # ä¼èª¬ãƒ©ãƒ³ã‚¯åˆ¤å®š)
            if total_evolution >= 40:)
                legendary_rank = "ğŸŒŸ ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰")
            elif total_evolution >= 30:)
                legendary_rank = "ğŸ’ ãƒã‚¹ã‚¿ãƒ¼")
            elif total_evolution >= 20:)
                legendary_rank = "ğŸ† ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ")
            elif total_evolution >= 10:)
                legendary_rank = "ğŸ¥‡ ã‚¢ãƒ‰ãƒãƒ³ã‚¹")
            else:)
                legendary_rank = "ğŸ¥ˆ ãƒ“ã‚®ãƒŠãƒ¼")
            )
            return {)
                "battle_type": "legendary",)
                "analysis_period": f"{first_phase[4]}å¹´ã€œ{latest_phase[5]}å¹´",)
                "total_phases": len(phases_data),)
                "first_phase_usage": first_usage,)
                "latest_phase_usage": latest_usage,)
                "total_evolution": total_evolution,)
                "phase_improvements": phase_improvements,)
                "legendary_rank": legendary_rank,)
                "legendary_summary": f"6å¹´é–“ã®ç·åˆé€²åŒ–: {total_evolution:.1f}%æ”¹å–„ ({legendary_rank})")
            })
    )
    def generate_battle_report(self, year: int, month: int) -> str:)
        """ç·åˆãƒãƒˆãƒ«ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ""")
        report = f"# ğŸ† {year}å¹´{month}æœˆ é©æ–°çš„5æ®µéšãƒãƒˆãƒ«ãƒ¬ãƒãƒ¼ãƒˆ\n\n")
        )
        # 1. Historic Battle (å‰å¹´åŒæœˆ))
        historic = self.historic_battle(year-1, month, year, month))
        if "error" not in historic:)
            report += f"## {self.battle_types['historic']['emoji']} Historic Battle\n")
            report += f"**{historic['battle_summary']}**\n")
            report += f"çµæœ: {historic['result_emoji']} {historic['winner']}ã®å‹åˆ©\n\n")
        )
        # 2. Ultimate Battle (HANAZONOã‚·ã‚¹ãƒ†ãƒ åŠ¹æœ))
        ultimate = self.ultimate_battle(year, month))
        if "error" not in ultimate:)
            report += f"## {self.battle_types['ultimate']['emoji']} Ultimate Battle\n")
            report += f"**{ultimate['ultimate_summary']}**\n")
            report += f"å‹åˆ©: {'âœ…' if ultimate['victory'] else 'âŒ'}\n\n")
        )
        # 3. Legendary Battle (å…¨æœŸé–“çµ±åˆ))
        legendary = self.legendary_battle())
        if "error" not in legendary:)
            report += f"## {self.battle_types['legendary']['emoji']} Legendary Battle\n")
            report += f"**{legendary['legendary_summary']}**\n")
            report += f"åˆ†ææœŸé–“: {legendary['analysis_period']}\n\n")
        )
        return report)
    )
    def get_current_achievements(self) -> List[Dict]:)
        """ç¾åœ¨ã®å®Ÿç¸¾ã‚’å–å¾—""")
        # å®Ÿç¸¾åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç°¡ç•¥ç‰ˆï¼‰)
        achievements = [])
        )
        # Legendary Battleã®çµæœã‹ã‚‰å®Ÿç¸¾åˆ¤å®š)
        legendary = self.legendary_battle())
        if "error" not in legendary:)
            if legendary["total_evolution"] >= 50:)
                achievements.append(self.achievements["efficiency_master"]))
            if legendary["legendary_rank"] == "ğŸŒŸ ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰":)
                achievements.append(self.achievements["legendary_champion"]))
        )
        return achievements)
)
def main():)
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†""")
    battle_system = RevolutionaryBattleSystem())
    )
    print("ğŸ”¥ é©æ–°çš„5æ®µéšãƒãƒˆãƒ«ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ï¼"))
    print("=========================================="))
    )
    # ç¾åœ¨ã®æœˆã§ãƒãƒˆãƒ«ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ)
    now = datetime.now())
    report = battle_system.generate_battle_report(now.year, now.month))
    print(report))
    )
    # å®Ÿç¸¾ç¢ºèª)
    achievements = battle_system.get_current_achievements())
    if achievements:)
        print("ğŸ… ç²å¾—å®Ÿç¸¾:"))
        for achievement in achievements:)
            print(f"  {achievement['emoji']} {achievement['name']}: {achievement['description']}"))
    )
    print("\nâœ… é©æ–°çš„5æ®µéšãƒãƒˆãƒ«ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†ï¼"))
)
if __name__ == "__main__":)
    main())
