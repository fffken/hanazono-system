#!/usr/bin/env python3)
""")
GitHubè‡ªå‹•èª¿æŸ»ãƒ»ä¿®æ­£çµ±åˆã‚·ã‚¹ãƒ†ãƒ  v1.0)
ç©¶æ¥µã®è‡ªå‹•åŒ–ï¼šäººé–“ã®æ‰‹ä½œæ¥­å®Œå…¨æ’é™¤)
""")
import os)
import subprocess)
import json)
import re)
import requests)
import time)
from datetime import datetime)
from pathlib import Path)
)
class GitHubAutoInvestigator:)
    def __init__(self):)
        self.base_dir = "/home/pi/lvyuan_solar_control")
        self.repo_owner = "fffken")
        self.repo_name = "hanazono-system")
        self.github_raw_base = f"https://raw.githubusercontent.com/{self.repo_owner}/{self.repo_name}/main")
        self.issues_found = [])
        self.fixes_applied = [])
        )
    def run_full_investigation(self):)
        """å®Œå…¨è‡ªå‹•èª¿æŸ»ãƒ»ä¿®æ­£å®Ÿè¡Œ""")
        print("ğŸ” GitHubè‡ªå‹•èª¿æŸ»ãƒ»ä¿®æ­£çµ±åˆã‚·ã‚¹ãƒ†ãƒ  v1.0"))
        print("=" * 60))
        print("ğŸ¤– ç©¶æ¥µã®è‡ªå‹•åŒ–é–‹å§‹ï¼šäººé–“ã®æ‰‹ä½œæ¥­å®Œå…¨æ’é™¤"))
        )
        # Phase 1: GitHubè‡ªå‹•èª¿æŸ»)
        print("\nğŸ“¡ Phase 1: GitHubè‡ªå‹•èª¿æŸ»å®Ÿè¡Œä¸­..."))
        github_files = self._scan_github_repository())
        )
        # Phase 2: ãƒ­ãƒ¼ã‚«ãƒ«ã¨ã®å·®åˆ†åˆ†æ)
        print("\nğŸ” Phase 2: ãƒ­ãƒ¼ã‚«ãƒ«å·®åˆ†è‡ªå‹•åˆ†æ..."))
        issues = self._analyze_differences(github_files))
        )
        # Phase 3: å•é¡Œè‡ªå‹•æ¤œå‡º)
        print("\nâš ï¸ Phase 3: ã‚·ã‚¹ãƒ†ãƒ å•é¡Œè‡ªå‹•æ¤œå‡º..."))
        system_issues = self._detect_system_issues())
        )
        # Phase 4: AIè‡ªå‹•ä¿®æ­£)
        print("\nğŸ”§ Phase 4: AIè‡ªå‹•ä¿®æ­£å®Ÿè¡Œ..."))
        fixes = self._auto_fix_issues(issues + system_issues))
        )
        # Phase 5: è‡ªå‹•ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼)
        print("\nğŸ§ª Phase 5: è‡ªå‹•ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼..."))
        test_results = self._auto_test_system())
        )
        # Phase 6: è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤)
        print("\nğŸš€ Phase 6: è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤..."))
        deploy_success = self._auto_deploy())
        )
        # çµæœãƒ¬ãƒãƒ¼ãƒˆ)
        self._generate_investigation_report(fixes, test_results, deploy_success))
        )
    def _scan_github_repository(self):)
        """GitHub ãƒªãƒã‚¸ãƒˆãƒªè‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³""")
        files_to_check = [)
            "AI_WORK_RULES.md",)
            "PROJECT_STATUS.md", )
            "github_auto_handover.md",)
            "main.py",)
            "email_notifier.py",)
            "enhanced_email_system_v2.py",)
            "hanazono_dashboard.py",)
            "settings.json")
        ])
        )
        github_files = {})
        for file_path in files_to_check:)
            try:)
                url = f"{self.github_raw_base}/{file_path}")
                response = requests.get(url, timeout=10))
                if response.status_code == 200:)
                    github_files[file_path] = response.text)
                    print(f"   âœ… {file_path}: å–å¾—æˆåŠŸ"))
                else:)
                    print(f"   âŒ {file_path}: å–å¾—å¤±æ•— ({response.status_code})"))
            except Exception as e:)
                print(f"   âš ï¸ {file_path}: æ¥ç¶šã‚¨ãƒ©ãƒ¼ ({e})"))
                )
        return github_files)
        )
    def _analyze_differences(self, github_files):)
        """ãƒ­ãƒ¼ã‚«ãƒ«ã¨GitHubã®å·®åˆ†è‡ªå‹•åˆ†æ""")
        issues = [])
        )
        for file_path, github_content in github_files.items():)
            local_path = Path(self.base_dir) / file_path)
            if local_path.exists():)
                try:)
                    with open(local_path, 'r') as f:)
                        local_content = f.read())
                    )
                    if local_content != github_content:)
                        issues.append({)
                            'type': 'file_diff',)
                            'file': file_path,)
                            'description': f'{file_path}ã®ãƒ­ãƒ¼ã‚«ãƒ«ã¨GitHubã§å·®åˆ†ã‚ã‚Š',)
                            'severity': 'medium')
                        }))
                        print(f"   ğŸ“ å·®åˆ†æ¤œå‡º: {file_path}"))
                except Exception as e:)
                    issues.append({)
                        'type': 'file_error',)
                        'file': file_path,)
                        'description': f'{file_path}èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}',)
                        'severity': 'high')
                    }))
            else:)
                issues.append({)
                    'type': 'missing_file',)
                    'file': file_path,)
                    'description': f'{file_path}ãŒãƒ­ãƒ¼ã‚«ãƒ«ã«å­˜åœ¨ã—ãªã„',)
                    'severity': 'high')
                }))
                )
        return issues)
        )
    def _detect_system_issues(self):)
        """ã‚·ã‚¹ãƒ†ãƒ å•é¡Œè‡ªå‹•æ¤œå‡º""")
        issues = [])
        )
        # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å•é¡Œæ¤œå‡º)
        log_files = [)
            "logs/cron_daily_report_morning.log",)
            "logs/cron_daily_report_night.log", )
            "solar_control.log")
        ])
        )
        for log_file in log_files:)
            log_path = Path(self.base_dir) / log_file)
            if log_path.exists():)
                try:)
                    with open(log_path, 'r') as f:)
                        log_content = f.read())
                    )
                    # ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º)
                    error_patterns = [)
                        (r'ERROR.*ãƒãƒƒãƒ†ãƒªãƒ¼.*N/A', 'battery_extraction_error'),)
                        (r'ERROR.*ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼', 'email_error'),)
                        (r'ERROR.*ãƒ‡ãƒ¼ã‚¿å–å¾—.*å¤±æ•—', 'data_collection_error'),)
                        (r'ERROR.*æ¥ç¶š.*å¤±æ•—', 'connection_error'))
                    ])
                    )
                    for pattern, issue_type in error_patterns:)
                        if re.search(pattern, log_content):)
                            issues.append({)
                                'type': issue_type,)
                                'file': log_file,)
                                'description': f'{log_file}ã§ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º: {issue_type}',)
                                'severity': 'high')
                            }))
                            print(f"   ğŸš¨ å•é¡Œæ¤œå‡º: {issue_type} in {log_file}"))
                            )
                except Exception as e:)
                    print(f"   âš ï¸ ãƒ­ã‚°åˆ†æã‚¨ãƒ©ãƒ¼: {log_file} - {e}"))
        )
        # ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹å•é¡Œæ¤œå‡º)
        try:)
            import psutil)
            cpu_percent = psutil.cpu_percent(interval=1))
            memory_percent = psutil.virtual_memory().percent)
            disk_percent = psutil.disk_usage('/').percent)
            )
            if cpu_percent > 90:)
                issues.append({)
                    'type': 'high_cpu',)
                    'description': f'CPUä½¿ç”¨ç‡ç•°å¸¸: {cpu_percent}%',)
                    'severity': 'medium')
                }))
            if memory_percent > 90:)
                issues.append({)
                    'type': 'high_memory', )
                    'description': f'ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ç•°å¸¸: {memory_percent}%',)
                    'severity': 'medium')
                }))
            if disk_percent > 95:)
                issues.append({)
                    'type': 'disk_full',)
                    'description': f'ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ä¸è¶³: {disk_percent}%',)
                    'severity': 'high')
                }))
        except:)
            pass)
            )
        return issues)
        )
    def _auto_fix_issues(self, issues):)
        """AIè‡ªå‹•ä¿®æ­£å®Ÿè¡Œ""")
        fixes = [])
        )
        for issue in issues:)
            fix_result = None)
            )
            if issue['type'] == 'battery_extraction_error':)
                fix_result = self._fix_battery_extraction())
            elif issue['type'] == 'email_error':)
                fix_result = self._fix_email_issues())
            elif issue['type'] == 'data_collection_error':)
                fix_result = self._fix_data_collection())
            elif issue['type'] == 'missing_file':)
                fix_result = self._fix_missing_file(issue['file']))
            elif issue['type'] == 'high_cpu':)
                fix_result = self._fix_high_cpu())
            elif issue['type'] == 'disk_full':)
                fix_result = self._fix_disk_space())
                )
            if fix_result:)
                fixes.append({)
                    'issue': issue,)
                    'fix': fix_result,)
                    'timestamp': datetime.now().isoformat())
                }))
                print(f"   âœ… è‡ªå‹•ä¿®æ­£å®Œäº†: {issue['type']}"))
            else:)
                print(f"   âŒ è‡ªå‹•ä¿®æ­£å¤±æ•—: {issue['type']}"))
                )
        return fixes)
        )
    def _fix_battery_extraction(self):)
        """ãƒãƒƒãƒ†ãƒªãƒ¼æŠ½å‡ºå•é¡Œä¿®æ­£""")
        try:)
            # AIAutoResolverV2ã‚’ä½¿ç”¨)
            resolver_path = Path(self.base_dir) / "ai_auto_resolver_v2.py")
            if resolver_path.exists():)
                result = subprocess.run(['python3', str(resolver_path)], )
                                      capture_output=True, text=True))
                return "AIè‡ªå‹•ä¿®æ­£ã‚·ã‚¹ãƒ†ãƒ v2.0å®Ÿè¡Œ" if result.returncode == 0 else None)
        except:)
            pass)
        return None)
        )
    def _fix_email_issues(self):)
        """ãƒ¡ãƒ¼ãƒ«å•é¡Œä¿®æ­£""")
        # SMTPãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª)
        try:)
            settings_path = Path(self.base_dir) / "settings.json")
            if settings_path.exists():)
                with open(settings_path, 'r') as f:)
                    settings = json.load(f))
                )
                smtp_password = settings.get('email', {}).get('smtp_password', ''))
                if smtp_password == '${SMTP_PASSWORD}':)
                    return "SMTPç’°å¢ƒå¤‰æ•°è¨­å®šãŒå¿…è¦")
                    )
        except:)
            pass)
        return "ãƒ¡ãƒ¼ãƒ«è¨­å®šç¢ºèªæ¸ˆã¿")
        )
    def _fix_data_collection(self):)
        """ãƒ‡ãƒ¼ã‚¿åé›†å•é¡Œä¿®æ­£""")
        try:)
            # æ‰‹å‹•ãƒ‡ãƒ¼ã‚¿åé›†ãƒ†ã‚¹ãƒˆ)
            result = subprocess.run(['python3', 'main.py', '--collect'], )
                                  cwd=self.base_dir, capture_output=True, text=True, timeout=30))
            return "ãƒ‡ãƒ¼ã‚¿åé›†ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ" if result.returncode == 0 else None)
        except:)
            pass)
        return None)
        )
    def _fix_missing_file(self, file_path):)
        """æ¬ æãƒ•ã‚¡ã‚¤ãƒ«ä¿®å¾©""")
        # GitHubã‹ã‚‰è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰)
        try:)
            url = f"{self.github_raw_base}/{file_path}")
            response = requests.get(url, timeout=10))
            if response.status_code == 200:)
                local_path = Path(self.base_dir) / file_path)
                local_path.parent.mkdir(parents=True, exist_ok=True))
                with open(local_path, 'w') as f:)
                    f.write(response.text))
                return f"GitHubã‹ã‚‰{file_path}ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰")
        except:)
            pass)
        return None)
        )
    def _fix_high_cpu(self):)
        """é«˜CPUä½¿ç”¨ç‡ä¿®æ­£""")
        try:)
            # é‡ã„ãƒ—ãƒ­ã‚»ã‚¹ã®ç¢ºèª)
            result = subprocess.run(['ps', 'aux', '--sort=-pcpu'], )
                                  capture_output=True, text=True))
            return "CPUãƒ—ãƒ­ã‚»ã‚¹ç¢ºèªæ¸ˆã¿")
        except:)
            pass)
        return None)
        )
    def _fix_disk_space(self):)
        """ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ä¿®æ­£""")
        try:)
            # å¤ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤)
            subprocess.run(['find', self.base_dir, '-name', '*.log', '-mtime', '+30', '-delete']))
            # Python cacheã‚¯ãƒªã‚¢)
            subprocess.run(['find', self.base_dir, '-name', '__pycache__', '-type', 'd', '-exec', 'rm', '-rf', '{}', '+']))
            return "ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œ")
        except:)
            pass)
        return None)
        )
    def _auto_test_system(self):)
        """ã‚·ã‚¹ãƒ†ãƒ è‡ªå‹•ãƒ†ã‚¹ãƒˆ""")
        test_results = {})
        )
        # ãƒ‡ãƒ¼ã‚¿åé›†ãƒ†ã‚¹ãƒˆ)
        try:)
            result = subprocess.run(['python3', 'main.py', '--collect'], )
                                  cwd=self.base_dir, capture_output=True, text=True, timeout=30))
            test_results['data_collection'] = result.returncode == 0)
        except:)
            test_results['data_collection'] = False)
            )
        # ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ†ã‚¹ãƒˆï¼ˆãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼‰)
        try:)
            result = subprocess.run(['python3', '-c', )
                'from email_notifier import EmailNotifier; print("Import OK")'], )
                cwd=self.base_dir, capture_output=True, text=True))
            test_results['email_system'] = result.returncode == 0)
        except:)
            test_results['email_system'] = False)
            )
        # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ)
        try:)
            result = subprocess.run(['python3', '-c', )
                'from hanazono_dashboard import HANAZONODashboard; print("Import OK")'], )
                cwd=self.base_dir, capture_output=True, text=True))
            test_results['dashboard'] = result.returncode == 0)
        except:)
            test_results['dashboard'] = False)
            )
        return test_results)
        )
    def _auto_deploy(self):)
        """è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤""")
        try:)
            # Gitè‡ªå‹•æ•´ç†ãƒ»ãƒ—ãƒƒã‚·ãƒ¥)
            script_path = Path(self.base_dir) / "scripts" / "auto_git_organize_push.sh")
            if script_path.exists():)
                result = subprocess.run(['bash', str(script_path)], )
                                      cwd=self.base_dir, capture_output=True, text=True))
                return result.returncode == 0)
        except:)
            pass)
        return False)
        )
    def _generate_investigation_report(self, fixes, test_results, deploy_success):)
        """èª¿æŸ»çµæœãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ""")
        print("\n" + "=" * 60))
        print("ğŸ“Š GitHubè‡ªå‹•èª¿æŸ»ãƒ»ä¿®æ­£å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ"))
        print("=" * 60))
        )
        print(f"\nğŸ”§ è‡ªå‹•ä¿®æ­£å®Ÿè¡Œ: {len(fixes)}ä»¶"))
        for fix in fixes:)
            print(f"   â€¢ {fix['issue']['type']}: {fix['fix']}"))
            )
        print(f"\nğŸ§ª ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆçµæœ:"))
        for test_name, result in test_results.items():)
            status = "âœ… æˆåŠŸ" if result else "âŒ å¤±æ•—")
            print(f"   â€¢ {test_name}: {status}"))
            )
        print(f"\nğŸš€ è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤: {'âœ… æˆåŠŸ' if deploy_success else 'âŒ å¤±æ•—'}"))
        )
        print(f"\nğŸ¯ æ¬¡å›å®Ÿè¡Œæ¨å¥¨:"))
        if len(fixes) == 0 and all(test_results.values()):)
            print("   âœ… ã‚·ã‚¹ãƒ†ãƒ æœ€é©åŒ–æ¸ˆã¿ - å®šæœŸç›£è¦–ç¶™ç¶š"))
        else:)
            print("   ğŸ”„ 24æ™‚é–“å¾Œã«å†èª¿æŸ»æ¨å¥¨"))
            )
        print("=" * 60))
)
if __name__ == "__main__":)
    investigator = GitHubAutoInvestigator())
    investigator.run_full_investigation())
