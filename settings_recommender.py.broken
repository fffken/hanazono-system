#!/usr/bin/env python3)
""")
HANAZONOã‚·ã‚¹ãƒ†ãƒ  è¨­å®šæ¨å¥¨ã‚¨ãƒ³ã‚¸ãƒ³ v1.0)
å¤©æ°—äºˆå ±ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æœ€é©è¨­å®šã‚’è‡ªå‹•è¨ˆç®—)
)
HANAZONO-SYSTEM-SETTINGS.mdã®è¨­å®šè¡¨ã‚’å®Œå…¨å®Ÿè£…)
""")
)
import json)
import sqlite3)
from datetime import datetime, timedelta)
from pathlib import Path)
)
class SettingsRecommender:)
    def __init__(self, settings_file="settings.json", db_path="data/hanazono_analysis.db"):)
        self.settings_file = settings_file)
        self.db_path = db_path)
        self.load_settings())
        )
        # HANAZONO-SYSTEM-SETTINGS.mdã®è¨­å®šè¡¨ã‚’å®Œå…¨å®Ÿè£…)
        self.base_settings = {)
            "winter": {)
                "season_period": "12æœˆ-3æœˆ",)
                "typeB": {"ID07": 60, "ID10": 60, "ID41": "03:00", "ID62": 60},)
                "typeA": {)
                    "normal": {"ID07": 60, "ID10": 60, "ID41": "03:00", "ID62": 60},)
                    "sunny_3days": {"ID07": 50, "ID10": 45, "ID41": "02:30", "ID62": 50},)
                    "rainy_3days": {"ID07": 70, "ID10": 75, "ID41": "03:30", "ID62": 70})
                })
            },)
            "spring_fall": {)
                "season_period": "4æœˆ-6æœˆ, 10æœˆ-11æœˆ",)
                "typeB": {"ID07": 50, "ID10": 45, "ID41": "03:00", "ID62": 45},)
                "typeA": {)
                    "normal": {"ID07": 50, "ID10": 45, "ID41": "03:00", "ID62": 35},)
                    "sunny_3days": {"ID07": 40, "ID10": 30, "ID41": "02:30", "ID62": 35},)
                    "rainy_3days": {"ID07": 60, "ID10": 60, "ID41": "03:30", "ID62": 55})
                })
            },)
            "summer": {)
                "season_period": "7æœˆ-9æœˆ",)
                "typeB": {"ID07": 35, "ID10": 30, "ID41": "03:00", "ID62": 35},)
                "typeA": {)
                    "normal": {"ID07": 35, "ID10": 30, "ID41": "03:00", "ID62": 35},)
                    "sunny_3days": {"ID07": 25, "ID10": 15, "ID41": "02:30", "ID62": 25},)
                    "rainy_3days": {"ID07": 45, "ID10": 45, "ID41": "03:30", "ID62": 45})
                })
            })
        })
        )
        # å¤©å€™åˆ¤æ–­ãƒ«ãƒ¼ãƒ«)
        self.weather_rules = {)
            "sunny_keywords": ["æ™´", "æ™´ã‚Œ", "å¿«æ™´"],)
            "rainy_keywords": ["é›¨", "é›·é›¨", "å¤§é›¨", "å°é›¨"],)
            "cloudy_keywords": ["æ›‡", "æ›‡ã‚Š", "ãã‚‚ã‚Š"],)
            "threshold_days": 3  # é€£ç¶šå¤©å€™åˆ¤æ–­ã®æ—¥æ•°)
        })
    )
    def load_settings(self):)
        """æ—¢å­˜è¨­å®šèª­ã¿è¾¼ã¿""")
        try:)
            with open(self.settings_file, 'r', encoding='utf-8') as f:)
                self.current_settings = json.load(f))
        except Exception as e:)
            print(f"âš ï¸ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}"))
            self.current_settings = {})
    )
    def get_current_season(self):)
        """ç¾åœ¨ã®å­£ç¯€ã‚’åˆ¤å®š""")
        month = datetime.now().month)
        )
        if month in [12, 1, 2, 3]:)
            return "winter")
        elif month in [4, 5, 6, 10, 11]:)
            return "spring_fall")
        elif month in [7, 8, 9]:)
            return "summer")
        else:)
            return "spring_fall"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
    )
    def analyze_weather_pattern(self, weather_data):)
        """)
        3æ—¥é–“ã®å¤©æ°—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ†æ)
        )
        Args:)
            weather_data: {)
                "today": {"weather": "æ™´ã‚Œ", "temp_max": 25, "temp_min": 15},)
                "tomorrow": {"weather": "æ›‡ã‚Š", "temp_max": 22, "temp_min": 14},)
                "day_after_tomorrow": {"weather": "é›¨", "temp_max": 20, "temp_min": 12})
            })
        )
        Returns:)
            str: "sunny_3days", "rainy_3days", "normal")
        """)
        if not weather_data:)
            return "normal")
        )
        days = ["today", "tomorrow", "day_after_tomorrow"])
        weather_conditions = [])
        )
        for day in days:)
            if day in weather_data:)
                weather = weather_data[day].get("weather", ""))
                weather_conditions.append(weather))
        )
        if len(weather_conditions) < 2:)
            return "normal")
        )
        # 3æ—¥é–“é€£ç¶šæ™´å¤©åˆ¤å®š)
        sunny_count = sum(1 for w in weather_conditions )
                         if any(keyword in w for keyword in self.weather_rules["sunny_keywords"])))
        )
        # 3æ—¥é–“é€£ç¶šé›¨å¤©åˆ¤å®š)
        rainy_count = sum(1 for w in weather_conditions )
                         if any(keyword in w for keyword in self.weather_rules["rainy_keywords"])))
        )
        if sunny_count >= 2:)
            return "sunny_3days")
        elif rainy_count >= 2:)
            return "rainy_3days")
        else:)
            return "normal")
    )
    def get_performance_data(self, days=7):)
        """éå»ã®æ€§èƒ½ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è£œæ­£å€¤ã‚’è¨ˆç®—""")
        try:)
            conn = sqlite3.connect(self.db_path))
            )
            query = ''')
                SELECT )
                    AVG(battery_soc) as avg_soc,)
                    MIN(battery_soc) as min_soc,)
                    MAX(battery_soc) as max_soc)
                FROM system_data )
                WHERE datetime > datetime('now', '-{} days'))
                AND battery_soc IS NOT NULL)
            '''.format(days))
            )
            cursor = conn.cursor())
            cursor.execute(query))
            result = cursor.fetchone())
            conn.close())
            )
            if result:)
                avg_soc, min_soc, max_soc = result)
                return {)
                    "avg_soc": avg_soc or 50,)
                    "min_soc": min_soc or 20,)
                    "max_soc": max_soc or 80,)
                    "soc_range": (max_soc or 80) - (min_soc or 20))
                })
        except Exception as e:)
            print(f"âš ï¸ æ€§èƒ½ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: {e}"))
        )
        return {"avg_soc": 50, "min_soc": 20, "max_soc": 80, "soc_range": 60})
    )
    def recommend_settings(self, weather_data, operation_mode="typeB"):)
        """)
        å¤©æ°—äºˆå ±ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æœ€é©è¨­å®šã‚’è¨ˆç®—)
        )
        Args:)
            weather_data: 3æ—¥åˆ†ã®å¤©æ°—äºˆå ±ãƒ‡ãƒ¼ã‚¿)
            operation_mode: "typeB" (çœç®¡ç†å‹) or "typeA" (å¤‰å‹•å‹))
            )
        Returns:)
            dict: æ¨å¥¨è¨­å®šå€¤ã¨è©³ç´°æƒ…å ±)
        """)
        season = self.get_current_season())
        weather_pattern = self.analyze_weather_pattern(weather_data))
        performance = self.get_performance_data())
        )
        # åŸºæœ¬è¨­å®šå–å¾—)
        if operation_mode == "typeB":)
            base_config = self.base_settings[season]["typeB"])
            change_type = "seasonal")
            change_reason = f"å­£ç¯€è¨­å®šï¼ˆ{self.base_settings[season]['season_period']}ï¼‰")
        else:)
            base_config = self.base_settings[season]["typeA"][weather_pattern])
            change_type = weather_pattern)
            )
            if weather_pattern == "sunny_3days":)
                change_reason = "â˜€ï¸ 3æ—¥é–“æ™´å¤©äºˆå ± - ç™ºé›»é‡å¢—åŠ ã«å‚™ãˆã¦æ”¾é›»è¨­å®šã‚’æ§ãˆã‚ã«")
            elif weather_pattern == "rainy_3days":)
                change_reason = "ğŸŒ§ï¸ 3æ—¥é–“é›¨å¤©äºˆå ± - ç™ºé›»é‡æ¸›å°‘ã«å‚™ãˆã¦è“„é›»è¨­å®šã‚’å¼·åŒ–")
            else:)
                change_reason = f"é€šå¸¸è¨­å®šï¼ˆ{self.base_settings[season]['season_period']}ï¼‰")
        )
        # æ€§èƒ½ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹è£œæ­£)
        correction = self._calculate_performance_correction(performance, weather_pattern))
        )
        # æœ€çµ‚è¨­å®šå€¤è¨ˆç®—)
        final_settings = {})
        for param, value in base_config.items():)
            if param in correction:)
                if isinstance(value, int):)
                    final_settings[param] = max(0, value + correction[param]))
                else:)
                    final_settings[param] = value)
            else:)
                final_settings[param] = value)
        )
        # ãƒ¡ãƒ¼ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ç”¨ã®çµµæ–‡å­—æ±ºå®š)
        title_emoji = self._get_title_emoji(season, change_type))
        )
        return {)
            "settings": final_settings,)
            "season": season,)
            "weather_pattern": weather_pattern,)
            "change_type": change_type,)
            "change_reason": change_reason,)
            "title_emoji": title_emoji,)
            "operation_mode": operation_mode,)
            "performance_data": performance,)
            "is_changed": change_type != "seasonal",)
            "confidence": self._calculate_confidence(weather_data, performance))
        })
    )
    def _calculate_performance_correction(self, performance, weather_pattern):)
        """æ€§èƒ½ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãè¨­å®šè£œæ­£å€¤ã‚’è¨ˆç®—""")
        correction = {"ID07": 0, "ID10": 0, "ID62": 0})
        )
        avg_soc = performance["avg_soc"])
        soc_range = performance["soc_range"])
        )
        # SOCãŒä½ã™ãã‚‹å ´åˆã®è£œæ­£)
        if avg_soc < 30:)
            correction["ID07"] += 5  # å……é›»é›»æµå¢—åŠ )
            correction["ID10"] += 5  # å……é›»æ™‚é–“å»¶é•·)
            correction["ID62"] += 5  # SOCè¨­å®šä¸Šæ˜‡)
        )
        # SOCãŒé«˜ã™ãã‚‹å ´åˆã®è£œæ­£)
        elif avg_soc > 70:)
            correction["ID07"] -= 3  # å……é›»é›»æµæ¸›å°‘)
            correction["ID10"] -= 3  # å……é›»æ™‚é–“çŸ­ç¸®)
            correction["ID62"] -= 3  # SOCè¨­å®šä½ä¸‹)
        )
        # å¤©å€™ã«ã‚ˆã‚‹è¿½åŠ è£œæ­£)
        if weather_pattern == "rainy_3days" and avg_soc < 40:)
            correction["ID62"] += 10  # é›¨å¤©æ™‚ã¯ç‰¹ã«è“„é›»é‡è¦–)
        )
        return correction)
    )
    def _get_title_emoji(self, season, change_type):)
        """ãƒ¡ãƒ¼ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ç”¨çµµæ–‡å­—ã‚’æ±ºå®š""")
        if change_type == "seasonal":)
            season_emojis = {)
                "winter": "â„ï¸",)
                "spring_fall": "ğŸŒ¸" if datetime.now().month <= 6 else "ğŸ‚",)
                "summer": "ğŸŒ»")
            })
            return season_emojis.get(season, "ğŸŒ¸"))
        elif change_type == "sunny_3days":)
            return "ğŸŸ ")
        elif change_type == "rainy_3days":)
            return "ğŸ”µ")
        else:)
            return "ğŸŸ£")
    )
    def _calculate_confidence(self, weather_data, performance):)
        """æ¨å¥¨è¨­å®šã®ä¿¡é ¼åº¦ã‚’è¨ˆç®—""")
        confidence = 5  # åŸºæœ¬ä¿¡é ¼åº¦)
        )
        # å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨æ€§)
        if weather_data and len(weather_data) >= 2:)
            confidence += 2)
        else:)
            confidence -= 1)
        )
        # æ€§èƒ½ãƒ‡ãƒ¼ã‚¿ã®å®‰å®šæ€§)
        if performance["soc_range"] < 30:  # SOCå¤‰å‹•ãŒå®‰å®š)
            confidence += 1)
        elif performance["soc_range"] > 50:  # SOCå¤‰å‹•ãŒæ¿€ã—ã„)
            confidence -= 1)
        )
        return min(5, max(1, confidence)))
    )
    def compare_with_current(self, recommended):)
        """ç¾åœ¨ã®è¨­å®šã¨æ¨å¥¨è¨­å®šã‚’æ¯”è¼ƒ""")
        try:)
            # ç¾åœ¨ã®è¨­å®šå€¤ã‚’å–å¾—ï¼ˆç°¡æ˜“ç‰ˆï¼‰)
            season = recommended["season"])
            current = self.base_settings[season]["typeB"]  # åŸºæœ¬è¨­å®šã¨æ¯”è¼ƒ)
            )
            changes = {})
            for param, new_value in recommended["settings"].items():)
                old_value = current.get(param))
                if old_value != new_value:)
                    changes[param] = {)
                        "old": old_value,)
                        "new": new_value,)
                        "change": f"{old_value} â†’ {new_value}")
                    })
            )
            return changes)
        except Exception as e:)
            print(f"âš ï¸ è¨­å®šæ¯”è¼ƒã‚¨ãƒ©ãƒ¼: {e}"))
            return {})
)
def test_recommender():)
    """è¨­å®šæ¨å¥¨ã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒ†ã‚¹ãƒˆ""")
    recommender = SettingsRecommender())
    )
    # ãƒ†ã‚¹ãƒˆç”¨å¤©æ°—ãƒ‡ãƒ¼ã‚¿)
    test_weather = {)
        "today": {"weather": "æ™´ã‚Œ", "temp_max": 25, "temp_min": 15},)
        "tomorrow": {"weather": "æ™´ã‚Œ", "temp_max": 27, "temp_min": 16},)
        "day_after_tomorrow": {"weather": "æ™´ã‚Œ", "temp_max": 26, "temp_min": 17})
    })
    )
    print("ğŸ”§ è¨­å®šæ¨å¥¨ã‚¨ãƒ³ã‚¸ãƒ³ ãƒ†ã‚¹ãƒˆé–‹å§‹"))
    print("=" * 50))
    )
    # ã‚¿ã‚¤ãƒ—Bï¼ˆçœç®¡ç†å‹ï¼‰ãƒ†ã‚¹ãƒˆ)
    print("ğŸ“‹ ã‚¿ã‚¤ãƒ—Bï¼ˆçœç®¡ç†å‹ï¼‰è¨­å®š:"))
    result_b = recommender.recommend_settings(test_weather, "typeB"))
    print(f"å­£ç¯€: {result_b['season']}"))
    print(f"è¨­å®š: {result_b['settings']}"))
    print(f"ç†ç”±: {result_b['change_reason']}"))
    print(f"çµµæ–‡å­—: {result_b['title_emoji']}"))
    print(f"ä¿¡é ¼åº¦: {'â­' * result_b['confidence']}"))
    )
    print())
    )
    # ã‚¿ã‚¤ãƒ—Aï¼ˆå¤‰å‹•å‹ï¼‰ãƒ†ã‚¹ãƒˆ)
    print("ğŸ”„ ã‚¿ã‚¤ãƒ—Aï¼ˆå¤‰å‹•å‹ï¼‰è¨­å®š:"))
    result_a = recommender.recommend_settings(test_weather, "typeA"))
    print(f"å¤©æ°—ãƒ‘ã‚¿ãƒ¼ãƒ³: {result_a['weather_pattern']}"))
    print(f"è¨­å®š: {result_a['settings']}"))
    print(f"ç†ç”±: {result_a['change_reason']}"))
    print(f"çµµæ–‡å­—: {result_a['title_emoji']}"))
    print(f"ä¿¡é ¼åº¦: {'â­' * result_a['confidence']}"))
    )
    # è¨­å®šå¤‰æ›´ç¢ºèª)
    changes = recommender.compare_with_current(result_a))
    if changes:)
        print(f"\nğŸ”„ è¨­å®šå¤‰æ›´:"))
        for param, change in changes.items():)
            print(f"  {param}: {change['change']}"))
    else:)
        print("\nâœ… è¨­å®šå¤‰æ›´ãªã—"))
    )
    print("\nâœ… ãƒ†ã‚¹ãƒˆå®Œäº†"))
)
if __name__ == "__main__":)
    test_recommender())
