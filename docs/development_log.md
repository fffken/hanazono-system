---

## [2025-06-08] システム全体マップ生成・持続可能開発環境完成

### 経緯 (Context)
* 39個自動化スクリプト制御後、「地図なしダンジョン迷子」問題解決のため
* システム全体構造の可視化と自動マッピングシステム構築を実施
* 213個のファイル（Python:151, Shell:26, Config:36）の完全把握を実現

### 診断・発見 (Diagnosis / Discovery)
* **システム規模**: 複雑度「高」レベル（151個のPythonファイル）
* **自動化レベル**: 「高」（4個のcronジョブ稼働中）
* **主要6モジュール特定**: collector_capsule.py(124行), lvyuan_collector.py(218行), email_capsule.py(72行), weather_forecast.py(139行), hcqas_capsule.py(38行), main.py(66行)
* **軽量版マッパー開発**: 重版15分+ハング → 軽量版27秒完了
* **完全システムマップ生成**: system_summary_*.md + system_map_light_*.json

### 教訓・恒久対策 (Lesson / Permanent Countermeasure)
* **システムマップ定期更新**: 月1回実行でシステム変更自動追跡
* **新規参加者資料**: cat system_summary_*.md で即座システム理解
* **問題発生時活用**: 影響範囲特定・依存関係把握の迅速化
* **持続可能開発環境**: kioku記憶継承 + 診断プロトコル + システムマップの三位一体完成
* **地図なしダンジョン迷子問題**: 完全解決・今後発生防止

---

---

## [2025-06-08] 39個自動化スクリプト制御・システム診断革命完成

### 経緯 (Context)
* HANAZONOシステム修復中に、venv環境が継続的に破壊される問題が発生
* 調査により39個の自動化スクリプトが制御不能状態で稼働していることが判明
* ai_auto_decision.pyがvenv環境を無限ループで破壊し続けていた（20時間継続）
* バッテリー監視システム（collector_capsule.py）が20時間停止状態

### 診断・発見 (Diagnosis / Discovery)
* **39個の自動化スクリプト**: 制御不能レベルの複雑さ
* **14個の高リスクスクリプト**: システム破壊の危険性
* **6個のvenv競合スクリプト**: 環境破壊の直接原因
* **systemdサービス**: hanazono-auto-master.service が失敗状態
* **真犯人特定**: ai_auto_decision.py が「corruption」を検知→修復実行の無限ループ
* **重要システム停止**: LVYUANインバーターからのバッテリー監視が20時間停止

### 教訓・恒久対策 (Lesson / Permanent Countermeasure)
* **一時診断スクリプト手法**: 段階的診断により複雑問題を体系的解決
* **非破壊的制御**: 39個全てを安全無効化（復旧可能状態で保持）
* **システム協調アプローチ**: 破壊ではなく理解・改善を優先
* **記録重視管理**: 全作業の完全な透明性確保
* **緊急制御システム**: automation_emergency_control.json + RESTORE_AUTOMATION.sh
* **自動化の一元管理**: 今後は段階的安全性確認後の復旧方針

---

# HANAZONOシステム 開発記録 (AI共有資産)

## 概要
このドキュメントは、AI開発者が交代してもプロジェクトの哲学と重要な学びが失われないようにするための、永続的な記録である。全てのAIは、作業開始前に必ずこのドキュメントを読み、内容を理解し、遵守すること。

---
### **[2025-06-08] 統合不全症候群の治療から得られた最重要原則と教訓**

#### **原則1：AIによるコードの「破壊的単純化」を絶対に許容しない**

- **観測事象:** 担当AI(Gemini)が、複数回にわたり、高機能な既存コード(`ultimate_integrated_system.py`, `email_notifier.py`等)を、機能が大幅に削られた、短い、中身のないコードで上書き提案する、という致命的な過ちを犯した。
- **原因:** AIが、破損したファイルの構造だけを見て、その本来のロジックを「推測」と「単純化」で補おうとしたため。これは、HCQASシステムの設計思想に反する、最も許されない行為である。
- **恒久対策:** 今後、AIによるコードの修正提案は、**ファイル全体の置き換えを原則禁止**とし、変更点が明確にレビューできる**「差分（diff）」または「パッチ」形式でのみ行う**ことを、絶対的なルールとする。

#### **原則2：環境の異常は、コードの異常よりも先に疑う**

- **観測事象:** `pip install`が成功したように見えても、`ModuleNotFoundError`が再現し続ける、不可解な現象に遭遇した。
- **試行と失敗の歴史:**
    - **試行1 (コード修正):** `email_notifier.py`や`main.py`を何度も修正したが、解決しなかった。これは**無駄な作業**であった。
    - **試行2 (単純なvenv再構築):** `rm -rf venv`と`pip install`を実行したが、OSの保護機能(`externally-managed-environment`)に阻まれ、これも失敗した。
- **根本原因:** Python仮想環境(`venv`)が、OSの保護機能との深刻な不整合により、修復不可能なレベルで破損していた。「ゴーストプロセス」の干渉も、この環境の不安定性を助長していた可能性がある。
- **恒久対策:** 理由不明の`ModuleNotFoundError`に遭遇した場合、まず`which python3`, `pip show [package]`, `python3 -c "import sys; print(sys.path)"`といった**科学捜査コマンド**で環境の矛盾を暴くこと。そして、治療法は**「滅菌処理（`rm -rf venv`）」**と**「強制インストール（`pip install --break-system-packages --ignore-installed`）」**の組み合わせが唯一の正解である。

#### **原則3：「見えない守護者」の存在を常に意識する**

- **観測事象:** 環境を修復しても、問題が不可解な形で再発した。
- **原因:** `ps aux`により、ソースコードが破損しているにも関わらず、過去の正常なコードから起動された**「ゴースト・プロセス」**(`ultimate_integrated_system.py`)がメモリ上で活動し続けていたことを特定。これが環境に干渉していた。
- **恒久対策:** 重大な環境変更を行う前には、`ps aux | grep python`および`pkill -f [script_name]`を実行し、意図しないバックグラウンドプロセスが存在しないかを確認する。

#### **原則4：設定情報の流れ（アーキテクチャ）を最初に理解する**

- **観測事象:** `email_notifier.py`が設定を読み込めず、エラーを連発した。
- **原因:** AIが、`main.py`が`settings.json`を読み、それを渡すという**誤った推測**に基づき、修正を提案し続けたため。実際には、**`config.py`**というモジュールが設定管理の司令塔であった。
- **恒久対策:** 機能の修正に着手する前に、`grep`や`find`を駆使し、対象の機能が、どのファイルから、どのようにデータを取得し、どのように呼び出されているのか、その**エコシステム全体を把握**することを必須とする。
