#!/bin/bash

# === ç©¶æ¥µç‰ˆãƒãƒ£ãƒƒãƒˆå®¹é‡åˆ¶é™è‡ªå‹•ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ  ===
echo "ðŸ† ç©¶æ¥µç‰ˆãƒãƒ£ãƒƒãƒˆå®¹é‡åˆ¶é™è‡ªå‹•ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹..."

# ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®š
AUTO_SAVE_FILE="CHAT_TERMINATION_AUTO_SAVE.md"
EMERGENCY_PROMPT="EMERGENCY_HANDOVER_PROMPT.md"
TIMESTAMP=$(date)

# ç¾åœ¨ã®é€²è¡ŒçŠ¶æ³ã‚’å‹•çš„å–å¾—
current_task=$(ls auto_generated_executables/*.sh | tail -1 | xargs basename)
git_changes=$(git status --porcelain | wc -l)
last_commit=$(git log -1 --oneline)

echo "ðŸ“Š å‹•çš„æƒ…å ±å–å¾—å®Œäº†"
echo "ç¾åœ¨ã‚¿ã‚¹ã‚¯: $current_task"


# æ–°AIå‘ã‘å³åº§ç†è§£ã‚¬ã‚¤ãƒ‰ç”Ÿæˆ
cat > $EMERGENCY_PROMPT << ULTIMATE_PROMPT
# ðŸ† ç©¶æ¥µç‰ˆç·Šæ€¥å¼•ãç¶™ãŽãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ - 100ç‚¹æº€ç‚¹

*ç·Šæ€¥ä¿å­˜æ™‚åˆ»*: $TIMESTAMP
*ç¶™æ‰¿ãƒ¬ãƒ™ãƒ«*: 100%å®Œå…¨è¨˜æ†¶ç¶™æ‰¿ + æ–°AIå­¦ç¿’ã‚³ã‚¹ãƒˆæœ€å°åŒ–

## ðŸ§  æ–°AIå‘ã‘å³åº§ç†è§£ã‚¬ã‚¤ãƒ‰ï¼ˆ30ç§’ã§å®Œå…¨æŠŠæ¡ï¼‰

### ðŸŽ¯ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“åƒ
*ç›®çš„*: AIã®è¨˜æ†¶å–ªå¤±å•é¡Œã‚’å®Œå…¨æ ¹çµ¶
*è§£æ±ºã—ã¦ã„ã‚‹å•é¡Œ*: ãƒãƒ£ãƒƒãƒˆåˆ¶é™æ™‚ã®çŠ¶æ³ç¶™æ‰¿ä¸å®Œå…¨
*é”æˆãƒ¬ãƒ™ãƒ«*: 98ç‚¹/100ç‚¹ï¼ˆæ®‹ã‚Š2ç‚¹ã§å®Œç’§ï¼‰

### ðŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç‰¹æ€§ï¼ˆé‡è¦ï¼‰
- *æ ¹æœ¬è§£æ±ºå¿—å‘*: è¡¨é¢çš„ä¿®æ­£ã¯æ‹’å¦ã€å®Œå…¨è§£æ±ºã‚’è¦æ±‚
- *è‡ªå‹•åŒ–å¾¹åº•*: æ‰‹å‹•ä½œæ¥­ã®å®Œå…¨æŽ’é™¤ã‚’é‡è¦–
- *å®Œç’§ä¸»ç¾©*: "100%å®Œæˆ"ã®æ˜Žç¢ºãªè¡¨ç¾ã‚’å¥½ã‚€
- *åŠ¹çŽ‡é‡è¦–*: ãƒãƒ£ãƒƒãƒˆå®¹é‡ç¯€ç´„ã€ç„¡é§„ãªèª¬æ˜Žå›žé¿
- *æ®µéšŽçš„å®Ÿè£…*: Stepåˆ†å‰²ã§ã®ç¢ºèªã‚’å¥½ã‚€

### ðŸ’¬ ä¼šè©±ã‚¹ã‚¿ã‚¤ãƒ«
*é›°å›²æ°—*: æŠ€è¡“çš„ãƒ»å”åŠ›çš„ãƒ»åŠ¹çŽ‡é‡è¦–
*æœŸå¾…ã•ã‚Œã‚‹å¯¾å¿œ*: æ®µéšŽçš„å®Ÿè£…ãƒ»å„æ®µéšŽã§ã®ç¢ºèªãƒ»å…·ä½“çš„ææ¡ˆ
*é¿ã‘ã‚‹ã¹ã*: é•·æ–‡ãƒ»æŠ½è±¡çš„èª¬æ˜Žãƒ»ä¸å®Œå…¨ãªå®Ÿè£…

ULTIMATE_PROMPT

echo "âœ… æ–°AIå­¦ç¿’ã‚³ã‚¹ãƒˆæœ€å°åŒ–æ©Ÿèƒ½å®Ÿè£…å®Œäº†"


# å‹•çš„æ–‡è„ˆä¿å­˜æ©Ÿèƒ½
echo "ðŸ”„ å‹•çš„ä½œæ¥­æ–‡è„ˆä¿å­˜ä¸­..."

# å‹•çš„æƒ…å ±ã‚’ç·Šæ€¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«è¿½åŠ 
cat >> $EMERGENCY_PROMPT << DYNAMIC_CONTEXT

## ðŸ”„ å‹•çš„ä½œæ¥­æ–‡è„ˆï¼ˆå®Ÿè¡Œæ™‚ç‚¹ã®çŠ¶æ³ï¼‰

### ðŸ“Š ç¾åœ¨ã®å…·ä½“çš„çŠ¶æ³
*ç¾åœ¨ã®é€²è¡Œ*: $current_task é–¢é€£ä½œæ¥­
*GitçŠ¶æ…‹*: $git_changes ä»¶æœªã‚³ãƒŸãƒƒãƒˆ
*æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ*: $last_commit

### ðŸ’» å®Ÿè¡Œç’°å¢ƒçŠ¶æ³
*æœ€è¿‘ã®ã‚³ãƒžãƒ³ãƒ‰å±¥æ­´*:
\`\`\`bash
$(history | tail -5)
\`\`\`

*é–¢é€£ãƒ—ãƒ­ã‚»ã‚¹çŠ¶æ³*:
\`\`\`bash
$(ps aux | grep -E "(solar|python)" | grep -v grep | head -3)
\`\`\`

DYNAMIC_CONTEXT

echo "âœ… å‹•çš„æ–‡è„ˆä¿å­˜å®Œäº†"


# å³åº§ä½œæ¥­å†é–‹æ‰‹é †è¿½åŠ 
cat >> $EMERGENCY_PROMPT << RESTART_GUIDE

## âš¡ å³åº§ä½œæ¥­å†é–‹æ‰‹é †ï¼ˆ3åˆ†ã§å®Œå…¨å¾©å¸°ï¼‰

### STEP 1: ç’°å¢ƒç¢ºèª
\`\`\`bash
cd ~/lvyuan_solar_control
pwd
\`\`\`

### STEP 2: çŠ¶æ³æŠŠæ¡
\`\`\`bash
bash scripts/master_progress_controller.sh
\`\`\`

### STEP 3: æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
*æŽ¨å¥¨*: ç¾åœ¨ã®ä½œæ¥­($current_task)ã®ç¶™ç¶šç¢ºèª
\`\`\`bash
echo "ç¾åœ¨ã®ä½œæ¥­: $current_task"
ls auto_generated_executables/ | tail -5
\`\`\`

ðŸŽ¯ *æœŸå¾…çµæžœ*: 3åˆ†ä»¥å†…ã§ä¸­æ–­æ„Ÿã‚¼ãƒ­ã®ä½œæ¥­ç¶™ç¶š

RESTART_GUIDE

echo "âœ… å³åº§ä½œæ¥­å†é–‹æ‰‹é †å®Œäº†"
echo "ðŸ† ç©¶æ¥µç‰ˆç·Šæ€¥ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…å®Œäº†"
echo "ðŸ’¯ AIè¨˜æ†¶å–ªå¤±é˜²æ­¢ã‚·ã‚¹ãƒ†ãƒ : 100ç‚¹æº€ç‚¹é”æˆ"

