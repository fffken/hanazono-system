#!/usr/bin/env python3
"""
Complete Indentation Fix Script
ç›®çš„: å…¨ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ã®å®Œå…¨ä¿®å¾©
åŸå‰‡: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©æ—§ãƒ»å®‰å…¨ç¬¬ä¸€ãƒ»å³åº§å‰Šé™¤å¯¾è±¡
"""

import shutil
import glob
from datetime import datetime

def restore_from_latest_backup():
    """æœ€æ–°ã®å®‰å…¨ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©æ—§"""
    print("ğŸ›¡ï¸ å®‰å…¨ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©æ—§...")
    
    # å…¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ï¼ˆç ´æå‰ã®ã‚‚ã®ï¼‰
    backup_patterns = [
        "email_notifier_v2_1.py.realdata_fix_*",
        "email_notifier_v2_1.py.final_fix_*",
        "email_notifier_v2_1.py.direct_fix_*"
    ]
    
    all_backups = []
    for pattern in backup_patterns:
        all_backups.extend(glob.glob(pattern))
    
    # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§ã‚½ãƒ¼ãƒˆï¼ˆæœ€æ–°é †ï¼‰
    all_backups.sort(reverse=True)
    
    if all_backups:
        # æœ€æ–°ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’è©¦è¡Œ
        for backup_file in all_backups[:3]:  # æœ€æ–°3ã¤ã‚’è©¦è¡Œ
            print(f"ğŸ” ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèª: {backup_file}")
            
            # æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
            shutil.copy2(backup_file, "temp_test.py")
            try:
                import subprocess
                result = subprocess.run(['python3', '-m', 'py_compile', 'temp_test.py'], 
                                      capture_output=True, text=True)
                
                if result.returncode == 0:
                    print(f"âœ… å®‰å…¨ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç™ºè¦‹: {backup_file}")
                    
                    # ç¾åœ¨ã®ç ´æãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                    broken_backup = f"email_notifier_v2_1.py.broken_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
                    shutil.copy2("email_notifier_v2_1.py", broken_backup)
                    
                    # å®‰å…¨ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©æ—§
                    shutil.copy2(backup_file, "email_notifier_v2_1.py")
                    print(f"âœ… å¾©æ—§å®Œäº†: {backup_file} â†’ email_notifier_v2_1.py")
                    
                    # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
                    import os
                    os.remove("temp_test.py")
                    return True
                else:
                    print(f"âŒ æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã‚ã‚Š: {backup_file}")
                    
            except Exception as e:
                print(f"âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèªã‚¨ãƒ©ãƒ¼: {e}")
            
            # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
            try:
                import os
                os.remove("temp_test.py")
            except:
                pass
    
    print("âŒ å®‰å…¨ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    return False

def apply_minimal_battery_fix():
    """æœ€å°é™ã®ãƒãƒƒãƒ†ãƒªãƒ¼å®Ÿãƒ‡ãƒ¼ã‚¿ä¿®æ­£"""
    print("ğŸ”‹ æœ€å°é™ãƒãƒƒãƒ†ãƒªãƒ¼å®Ÿãƒ‡ãƒ¼ã‚¿ä¿®æ­£...")
    
    # æ–°ã—ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    backup_file = f"email_notifier_v2_1.py.minimal_fix_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
    shutil.copy2("email_notifier_v2_1.py", backup_file)
    print(f"âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: {backup_file}")
    
    with open("email_notifier_v2_1.py", 'r', encoding='utf-8') as f:
        content = f.read()
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸è¦ã§CollectorCapsuleã‹ã‚‰ç›´æ¥å–å¾—ã™ã‚‹é–¢æ•°ã«ç½®æ›
    old_battery_func = '''    def get_current_battery_status(self):
        """ç¾åœ¨ã®ãƒãƒƒãƒ†ãƒªãƒ¼çŠ¶æ³ã‚’å–å¾—"""
        try:
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            
            # æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            cursor.execute('''
                SELECT timestamp, battery_soc, battery_voltage, battery_current
                FROM battery_data
                ORDER BY timestamp DESC
                LIMIT 1
            ''')
            
            result = cursor.fetchone()
            conn.close()
            
            if result:
                return {
                    "timestamp": result[0],
                    "soc": result[1],
                    "voltage": result[2],
                    "current": result[3]
                }
                
        except Exception as e:
            self.logger.error(f"ãƒãƒƒãƒ†ãƒªãƒ¼çŠ¶æ³å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
        
        return None'''
    
    new_battery_func = '''    def get_current_battery_status(self):
        """ç¾åœ¨ã®ãƒãƒƒãƒ†ãƒªãƒ¼çŠ¶æ³ã‚’å–å¾—ï¼ˆCollectorCapsuleã‹ã‚‰ç›´æ¥ï¼‰"""
        try:
            from collector_capsule import CollectorCapsule
            from datetime import datetime
            
            collector = CollectorCapsule()
            data = collector.collect_lvyuan_data()
            
            if data and len(data) > 0 and isinstance(data[0], dict):
                battery_data = data[0]
                params = battery_data.get('parameters', {})
                
                # SOCã¨Voltageã‚’å–å¾—
                soc_data = params.get('0x0100', {})
                voltage_data = params.get('0x0101', {})
                
                return {
                    "timestamp": battery_data.get('datetime', datetime.now().strftime('%Y-%m-%d %H:%M:%S')),
                    "soc": soc_data.get('value', 'N/A'),
                    "voltage": voltage_data.get('value', 'N/A'),
                    "current": 'N/A'
                }
                
        except Exception as e:
            self.logger.error(f"ãƒãƒƒãƒ†ãƒªãƒ¼çŠ¶æ³å–å¾—ã‚¨ãƒ©ãƒ¼: {e}")
        
        return None'''
    
    if old_battery_func in content:
        content = content.replace(old_battery_func, new_battery_func)
        
        with open("email_notifier_v2_1.py", 'w', encoding='utf-8') as f:
            f.write(content)
        
        print("âœ… ãƒãƒƒãƒ†ãƒªãƒ¼å®Ÿãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤‰æ›´å®Œäº†")
        return True
    else:
        print("âš ï¸ å¯¾è±¡é–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        return False

def final_test():
    """æœ€çµ‚å‹•ä½œãƒ†ã‚¹ãƒˆ"""
    print("ğŸ§ª æœ€çµ‚å‹•ä½œãƒ†ã‚¹ãƒˆ...")
    
    try:
        import subprocess
        result = subprocess.run([
            'python3', 'main.py', '--daily-report', '--live'
        ], capture_output=True, text=True, timeout=60)
        
        print(f"ğŸ“Š çµ‚äº†ã‚³ãƒ¼ãƒ‰: {result.returncode}")
        
        if result.returncode == 0:
            print("âœ… å®Ÿãƒ‡ãƒ¼ã‚¿ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ")
            return True
        else:
            if result.stderr:
                for line in result.stderr.splitlines()[-5:]:
                    print(f"âŒ {line}")
            return False
            
    except Exception as e:
        print(f"âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {e}")
        return False

def main():
    print("ğŸ”§ Complete Indentation Fix")
    print(f"å®Ÿè¡Œæ™‚åˆ»: {datetime.now()}")
    print("ğŸ¯ ç›®çš„: å…¨ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼å®Œå…¨ä¿®å¾©")
    
    print("\n" + "="*60)
    print(" Phase 1: å®‰å…¨ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©æ—§")
    print("="*60)
    restore_ok = restore_from_latest_backup()
    
    if restore_ok:
        print("\n" + "="*60)
        print(" Phase 2: æœ€å°é™ãƒãƒƒãƒ†ãƒªãƒ¼å®Ÿãƒ‡ãƒ¼ã‚¿ä¿®æ­£")
        print("="*60)
        fix_ok = apply_minimal_battery_fix()
        
        if fix_ok:
            print("\n" + "="*60)
            print(" Phase 3: æœ€çµ‚å‹•ä½œãƒ†ã‚¹ãƒˆ")
            print("="*60)
            final_ok = final_test()
            
            if final_ok:
                print("\nğŸ‰ å®Œå…¨ä¿®å¾©æˆåŠŸï¼")
                print("ğŸ“§ å®Ÿãƒ‡ãƒ¼ã‚¿ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†")
            else:
                print("\nğŸ”§ æœ€çµ‚ãƒ†ã‚¹ãƒˆã§å•é¡Œç™ºç”Ÿ")
        else:
            print("\nâš ï¸ ãƒãƒƒãƒ†ãƒªãƒ¼ä¿®æ­£ã‚¹ã‚­ãƒƒãƒ—")
    else:
        print("\nâŒ å®‰å…¨ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")

if __name__ == "__main__":
    main()
