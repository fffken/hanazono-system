"""LVYUAN ã‚¤ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿åé›†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆæ”¹è‰¯ç‰ˆï¼‰""
import os
import time)
import json
import logging)
import socket)
import subprocess)
from datetime import datetime)
from pysolarmanv5 import PySolarmanV5)
)
class LVYUANCollector:)
)
    def __init__(self, settings_file=None):)
        if settings_file is None:)
            self.settings_file = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'settings.json'))
        else:)
            self.settings_file = settings_file)
        self.settings = self._load_settings())
        self.data_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'data'))
        os.makedirs(self.data_dir, exist_ok=True))
        self.logger = logging.getLogger('lvyuan_collector'))
        self._setup_logging())
)
    def _setup_logging(self):)
        """ãƒ­ã‚®ãƒ³ã‚°è¨­å®š""
        log_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'logs'))
        os.makedirs(log_dir, exist_ok=True))
        log_file = os.path.join(log_dir, f"collector_{datetime.now().strftime('%Y%m%d')}.log"))
        file_handler = logging.FileHandler(log_file))
        file_handler.setLevel(logging.INFO))
        console_handler = logging.StreamHandler())
        console_handler.setLevel(logging.INFO))
        formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s'))
        file_handler.setFormatter(formatter))
        console_handler.setFormatter(formatter))
        self.logger.addHandler(file_handler))
        self.logger.addHandler(console_handler))
        self.logger.setLevel(logging.INFO))
)
    def _load_settings(self):)
        """è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿""
        try:)
            if os.path.exists(self.settings_file):)
                with open(self.settings_file, 'r') as f:)
                    return json.load(f))
            else:)
                default_settings = {'inverter': {'ip': '192.168.0.202', 'serial': 3528830226, 'mac': 'D4:27:87:16:7A:F8', 'port': 8899, 'mb_slave_id': 1}, 'network': {'subnet': '192.168.0.0/24', 'last_check': '2025-05-02T02:00:00'}, 'monitoring': {'interval_minutes': 15, 'key_registers': [{'address': '0x0100', 'name': 'ãƒãƒƒãƒ†ãƒªãƒ¼SOC', 'unit': '%', 'factor': 1, 'emoji': 'ğŸ”‹'}, {'address': '0x0101', 'name': 'ãƒãƒƒãƒ†ãƒªãƒ¼é›»åœ§', 'unit': 'V', 'factor': 0.1, 'emoji': 'âš¡'}, {'address': '0x0102', 'name': 'ãƒãƒƒãƒ†ãƒªãƒ¼é›»æµ', 'unit': 'A', 'factor': 0.1, 'emoji': 'ğŸ”Œ'}, {'address': '0x020E', 'name': 'æ©Ÿå™¨çŠ¶æ…‹', 'unit': '', 'factor': 1, 'emoji': 'ğŸ“Š'}, {'address': '0xE012', 'name': 'ãƒ–ãƒ¼ã‚¹ãƒˆå……é›»æ™‚é–“', 'unit': 'åˆ†', 'factor': 1, 'emoji': 'â±ï¸'}]}})
                with open(self.settings_file, 'w') as f:)
                    json.dump(default_settings, f, indent=2))
                return default_settings)
        except Exception as e:)
            self.logger.error(f'è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}'))
            return {})
)
    def _save_settings(self):)
        """è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜""
        try:)
            with open(self.settings_file, 'w') as f:)
                json.dump(self.settings, f, indent=2))
            self.logger.debug('è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ'))
        except Exception as e:)
            self.logger.error(f'è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}'))
)
    def find_inverter_ip(self):)
        """ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¹ã‚­ãƒ£ãƒ³ã§ã‚¤ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç‰¹å®š""
        self.logger.info('ã‚¤ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ¤œç´¢ä¸­...'))
        current_ip = self.settings['inverter']['ip'])
        if self._check_inverter_connection(current_ip):)
            self.logger.info(f'ç¾åœ¨ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ ({current_ip}) ã«æ¥ç¶šã§ãã¾ã™'))
            return (current_ip, False))
        mac_address = self.settings['inverter']['mac'].replace(':', '-'))
        subnet = self.settings['network']['subnet'])
        try:)
            self.logger.info(f'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œä¸­... ({subnet})'))
            cmd = ['sudo', 'nmap', '-sP', subnet])
            subprocess.run(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE))
            cmd = ['arp', '-a'])
            result = subprocess.run(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True))
            for line in result.stdout.splitlines():)
                if mac_address.lower() in line.lower():)
                    parts = line.split())
                    for part in parts:)
                        if part.count('.') == 3:)
                            ip = part.strip('()'))
                            if self._check_inverter_connection(ip):)
                                if ip != current_ip:)
                                    self.logger.info(f'ã‚¤ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ: {current_ip} â†’ {ip}'))
                                    self.settings['inverter']['ip'] = ip)
                                    self._save_settings())
                                    return (ip, True))
                                else:)
                                    return (ip, False))
            self.logger.warning(f'ã‚¤ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ã®MACã‚¢ãƒ‰ãƒ¬ã‚¹ ({mac_address}) ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'))
            return (None, False))
        except Exception as e:)
            self.logger.error(f'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼: {e}'))
            return (None, False))
)
    def _check_inverter_connection(self, ip):)
        """ã‚¤ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ã¸ã®æ¥ç¶šç¢ºèª""
        try:)
            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM))
            s.settimeout(2))
            result = s.connect_ex((ip, self.settings['inverter']['port'])))
            s.close())
            if result == 0:)
                try:)
                    modbus = PySolarmanV5(address=ip, serial=self.settings['inverter']['serial'], port=self.settings['inverter']['port'], mb_slave_id=self.settings['inverter']['mb_slave_id'], verbose=False, socket_timeout=5))
                    modbus.read_holding_registers(256, 1))
                    return True)
                except Exception as e:)
                    self.logger.debug(f'Modbusæ¥ç¶šã‚¨ãƒ©ãƒ¼ ({ip}): {e}'))
                    return False)
            else:)
                self.logger.debug(f'ã‚½ã‚±ãƒƒãƒˆæ¥ç¶šå¤±æ•— ({ip}): {result}'))
                return False)
        except Exception as e:)
            self.logger.debug(f'æ¥ç¶šç¢ºèªã‚¨ãƒ©ãƒ¼ ({ip}): {e}'))
            return False)
)
    def collect_data(self):)
        """ã‚¤ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’åé›†""
        ip, ip_changed = self.find_inverter_ip())
        if ip is None:)
            self.logger.error('ã‚¤ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'))
            return (None, ip_changed))
        try:)
            modbus = PySolarmanV5(address=ip, serial=self.settings['inverter']['serial'], port=self.settings['inverter']['port'], mb_slave_id=self.settings['inverter']['mb_slave_id'], verbose=False, socket_timeout=10))
            data = {'timestamp': time.time(), 'datetime': datetime.now().strftime('%Y-%m-%d %H:%M:%S'), 'ip_address': ip, 'parameters': {}})
            for register_info in self.settings['monitoring']['key_registers']:)
                try:)
                    address = int(register_info['address'], 16))
                    raw_value = modbus.read_holding_registers(address, 1)[0])
                    scaled_value = raw_value * register_info['factor'])
                    if address == 526:)
                        state_desc = {0: 'èµ·å‹•ä¸­', 1: 'å¾…æ©Ÿä¸­', 2: 'é‹è»¢ä¸­', 3: 'ã‚½ãƒ•ãƒˆã‚¹ã‚¿ãƒ¼ãƒˆ', 4: 'ã‚°ãƒªãƒƒãƒ‰å‡ºåŠ›', 5: 'ã‚ªãƒ•ã‚°ãƒªãƒƒãƒ‰', 6: 'ç³»çµ±å‡ºåŠ›', 7: 'ç³»çµ±å´å‡ºåŠ›', 8: 'ã‚¢ãƒ©ãƒ¼ãƒ ', 9: 'æ®‹ã‚Š', 10: 'ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³', 11: 'æ•…éšœ'})
                        formatted_value = state_desc.get(raw_value, f'ä¸æ˜({raw_value})'))
                    elif register_info['factor'] == 1:)
                        formatted_value = str(int(scaled_value)))
                    else:)
                        formatted_value = f'{scaled_value:.1f}')
                    data['parameters'][register_info['address']] = {'name': register_info['name'], 'raw_value': raw_value, 'value': scaled_value, 'formatted_value': formatted_value, 'unit': register_info['unit'], 'emoji': register_info['emoji']})
                except Exception as e:)
                    self.logger.error(f"ãƒ¬ã‚¸ã‚¹ã‚¿ {register_info['address']} ({register_info['name']}) ã®èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼: {e}"))
            try:)
                model_code = modbus.read_holding_registers(24, 1)[0])
                data['device_info'] = {'model_code': model_code})
                try:)
                    ascii_regs = modbus.read_holding_registers(33, 40))
                    sn_string = '')
                    for reg in ascii_regs:)
                        if reg > 0:)
                            high_byte = reg >> 8 & 255)
                            low_byte = reg & 255)
                            if high_byte > 0:)
                                sn_string += chr(high_byte))
                            if low_byte > 0:)
                                sn_string += chr(low_byte))
                    if sn_string:)
                        data['device_info']['serial_string'] = sn_string.strip())
                except Exception as e:)
                    self.logger.debug(f'ã‚·ãƒªã‚¢ãƒ«ç•ªå·æ–‡å­—åˆ—ã®èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼: {e}'))
            except Exception as e:)
                self.logger.debug(f'ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã®èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼: {e}'))
            self._save_data(data))
            self.logger.info(f"ãƒ‡ãƒ¼ã‚¿åé›†æˆåŠŸ: {len(data['parameters'])}ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼, ã‚¤ãƒ³ãƒãƒ¼ã‚¿ãƒ¼IP: {ip}"))
            return (data, ip_changed))
        except Exception as e:)
            self.logger.error(f'ãƒ‡ãƒ¼ã‚¿åé›†ã‚¨ãƒ©ãƒ¼: {e}'))
            return (None, ip_changed))
)
    def _save_data(self, data):)
        """åé›†ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜""
        if data is None:)
            return)
        today = datetime.now().strftime('%Y%m%d'))
        filename = os.path.join(self.data_dir, f'data_{today}.json'))
        try:)
            existing_data = [])
            if os.path.exists(filename):)
                try:)
                    with open(filename, 'r') as f:)
                        existing_data = json.load(f))
                except json.JSONDecodeError:)
                    self.logger.warning(f'æ—¢å­˜ã®JSONãƒ•ã‚¡ã‚¤ãƒ« {filename} ãŒå£Šã‚Œã¦ã„ã¾ã™ã€‚æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚'))
            existing_data.append(data))
            with open(filename, 'w') as f:)
                json.dump(existing_data, f, indent=2))
            self.logger.debug(f'ãƒ‡ãƒ¼ã‚¿ã‚’ {filename} ã«ä¿å­˜ã—ã¾ã—ãŸ'))
        except Exception as e:)
            self.logger.error(f'ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}'))
if __name__ == '__main__':)
    import argparse)
    parser = argparse.ArgumentParser(description='LVYUANã‚¤ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿åé›†'))
    parser.add_argument('--scan', action='store_true', help='ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¹ã‚­ãƒ£ãƒ³ã§ã‚¤ãƒ³ãƒãƒ¼ã‚¿ãƒ¼IPã‚’æ¤œç´¢'))
    parser.add_argument('--collect', action='store_true', help='ãƒ‡ãƒ¼ã‚¿åé›†ã‚’å®Ÿè¡Œ'))
    parser.add_argument('--settings', help='è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹'))
    args = parser.parse_args())
    collector = LVYUANCollector(args.settings))
    if args.scan:)
        ip, changed = collector.find_inverter_ip())
        if ip:)
            print(f'ã‚¤ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹: {ip}'))
            if changed:)
                print('â€» IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ'))
        else:)
            print('ã‚¤ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'))
    if args.collect:)
        data, ip_changed = collector.collect_data())
        if data:)
            print(f"ãƒ‡ãƒ¼ã‚¿åé›†æˆåŠŸ: {len(data['parameters'])}ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼"))
            print('\n==== ä¸»è¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ===='))
            for address, param in data['parameters'].items():)
                print(f"{param['emoji']} {param['name']}: {param['formatted_value']}{param['unit']}"))
        else:)
            print('ãƒ‡ãƒ¼ã‚¿åé›†å¤±æ•—'))
    if not (args.scan or args.collect):)
        parser.print_help())