#!/usr/bin/env python3
# HANAZONOãƒ¡ãƒ¼ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ - è¨­è¨ˆæ€æƒ³æº–æ‹ ï¼ˆãƒ¡ã‚¤ãƒ³è§¦ã‚‰ãšãƒ»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ï¼‰
import os
import datetime

def create_proper_email_module():
    """è¨­è¨ˆæ€æƒ³ã«æ²¿ã£ãŸãƒ¡ãƒ¼ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆï¼ˆãƒ¡ã‚¤ãƒ³éå¤‰æ›´ï¼‰"""
    
    print("ğŸ¯ HANAZONOãƒ¡ãƒ¼ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆé–‹å§‹ï¼ˆè¨­è¨ˆæ€æƒ³æº–æ‹ ï¼‰")
    print("=" * 50)
    
    # 1. è¨­è¨ˆæ€æƒ³ã®ç¢ºèª
    print("ğŸ“‹ è¨­è¨ˆæ€æƒ³ç¢ºèª:")
    print("âœ… è¤‡é›‘åŒ–ã—ãªã„")
    print("âœ… çµ¶å¯¾ã«å£Šã‚Œãªã„") 
    print("âœ… ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã§ãƒ¡ã‚¤ãƒ³ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªã¾ã¾")
    print("âœ… ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯è§¦ã‚‰ãªã„")
    
    # 2. ç‹¬ç«‹ã—ãŸãƒ¡ãƒ¼ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ
    print("\nğŸ“‹ ç‹¬ç«‹ãƒ¡ãƒ¼ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ...")
    
    email_module_content = '''#!/usr/bin/env python3
# HANAZONOãƒ¡ãƒ¼ãƒ«ãƒãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« - ç‹¬ç«‹å‹•ä½œ
import smtplib
import ssl
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import datetime
import email_config

class HANAZONOEmailHub:
    """ç‹¬ç«‹ã—ãŸãƒ¡ãƒ¼ãƒ«ãƒãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«"""
    
    def __init__(self):
        self.enabled = email_config.EMAIL_ENABLED
        
    def send_detailed_report(self, report_data=None):
        """è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡"""
        try:
            if not self.enabled:
                print("ğŸ“§ ãƒ¡ãƒ¼ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«: ç„¡åŠ¹")
                return {"success": True, "mode": "disabled"}
            
            # è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ç”Ÿæˆ
            subject = f"æœ€é©åŒ–ãƒ¬ãƒãƒ¼ãƒˆ {datetime.datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')}"
            
            body = f"""ğŸ“§ HANAZONOã‚·ã‚¹ãƒ†ãƒ æœ€é©åŒ–ãƒ¬ãƒãƒ¼ãƒˆ {datetime.datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')} ({datetime.datetime.now().strftime('%Hæ™‚')})
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸŒ¤ï¸ å¤©æ°—äºˆå ±ã¨ç™ºé›»äºˆæ¸¬
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ä»Šæ—¥:    â˜€ï¸ æ™´ã‚Œ    æ°—æ¸©: æœ€é«˜30â„ƒ / æœ€ä½20â„ƒ
æ˜æ—¥:    â˜€ï¸ æ™´ã‚Œ    æ°—æ¸©: æœ€é«˜28â„ƒ / æœ€ä½22â„ƒ
æ˜å¾Œæ—¥:  â˜ï¸ æ›‡ã‚Š    æ°—æ¸©: æœ€é«˜25â„ƒ / æœ€ä½19â„ƒ
ç™ºé›»äºˆæ¸¬: é«˜ (3æ—¥é–“æ™´å¤©äºˆå ± + MLå­¦ç¿’ãƒ‡ãƒ¼ã‚¿)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”§ ä»Šæ—¥ã®æ¨å¥¨è¨­å®šï¼ˆMLæœ€é©åŒ– v3.2ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š ã‚¿ã‚¤ãƒ—Bï¼ˆçœç®¡ç†å‹ãƒ»è‡ªå‹•æœ€é©åŒ–ï¼‰- ç¾åœ¨é‹ç”¨ä¸­
ID 07: 32A (å……é›»é›»æµ)    ID 10: 30åˆ† (å……é›»æ™‚é–“)    ID 62: 32% (å‡ºåŠ›SOC)
ä¿¡é ¼åº¦: 85.0%    æ¬¡å›è¦‹ç›´ã—: 2025å¹´07æœˆ01æ—¥

ğŸ¯ ã‚¿ã‚¤ãƒ—Aï¼ˆè¿½åŠ æœ€é©åŒ–ãƒ»æ‰‹å‹•è¨­å®š 6ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼‰
ä¸»è¦è¨­å®š: ID07: 25A â†’ ID10: 23åˆ† â†’ ID62: 25%
æ™‚é–“åˆ¶å¾¡: ID40: 23æ™‚ (å……é›»é–‹å§‹) â†’ ID41: 2æ™‚ (å……é›»çµ‚äº†)
ä¿è­·è¨­å®š: ID28: 49V (ãƒãƒƒãƒ†ãƒªãƒ¼ä½é›»åœ§ä¿è­·)

ğŸ’¡ å¤‰æ›´æ¨å¥¨: âœ… æ¨å¥¨
ç†ç”±: 3æ—¥é–“æ™´å¤©äºˆå ±ã«ã‚ˆã‚Šç™ºé›»æœ€å¤§æ´»ç”¨å¯èƒ½ï¼ˆæ™‚é–“åˆ¶å¾¡å«ã‚€ï¼‰
æœŸå¾…è¿½åŠ åŠ¹æœ: +250å††/3æ—¥é–“
æ‰‹é–“ãƒ¬ãƒ™ãƒ«: 4/10 (ç°¡å˜)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ† 1å¹´å‰æ¯”è¼ƒãƒãƒˆãƒ«ï¼ˆHANAZONOã‚·ã‚¹ãƒ†ãƒ åŠ¹æœæ¸¬å®šï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“… 2024å¹´06æœˆ vs 2025å¹´06æœˆ é›»æ°—ä»£ãƒãƒˆãƒ«

å‰å¹´åŒæœˆ: Â¥16,000 (600kWh) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
ä»Šå¹´å®Ÿç¸¾: Â¥8,000 (350kWh) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 50%

ğŸ’° å‰Šæ¸›åŠ¹æœ: Â¥8,000 (50%å‰Šæ¸›)
ğŸ† åˆ¤å®š: ğŸ¥‡ å®Œå…¨å‹åˆ©ï¼ã‚·ã‚¹ãƒ†ãƒ å¤§æˆåŠŸï¼

ğŸ“Š å¹´é–“ãƒšãƒ¼ã‚¹
å¹´é–“å‰Šæ¸›äºˆæ¸¬: Â¥96,000 (50%å‰Šæ¸›)
ç›®æ¨™é”æˆç‡: 9600% (ç›®æ¨™Â¥100,000)
ğŸ¯ ã‚ªãƒ•ã‚°ãƒªãƒƒãƒ‰é”æˆç‡: 9500%%

ğŸŒŸ ä»Šæœˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
ãƒ»éå»æœ€é«˜ã®å‰Šæ¸›ç‡50%ã‚’é”æˆ
ãƒ»MLæœ€é©åŒ–ã«ã‚ˆã‚Šå‰æœˆæ¯”+5%åŠ¹ç‡å‘ä¸Š
ãƒ»æ™´å¤©æ—¥ã®ç™ºé›»åŠ¹ç‡ãŒ15%å‘ä¸Š

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“° æœ¬æ—¥ã®HANAZONO NEWS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‰ é€Ÿå ±ï¼6ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼MLæœ€é©åŒ–ã«ã‚ˆã‚Šå‰Šæ¸›åŠ¹æœãŒ5%å‘ä¸Šï¼
  ã‚¿ã‚¤ãƒ—AåŠ¹æœ: ID28ä¿è­·è¨­å®šè¿½åŠ ã«ã‚ˆã‚Šå®‰å…¨æ€§ã¨åŠ¹ç‡ã‚’ä¸¡ç«‹
  ã“ã®ãƒšãƒ¼ã‚¹ãªã‚‰å¹´é–“å‰Šæ¸›ç›®æ¨™ã‚’20%ä¸Šå›ã‚‹è¦‹è¾¼ã¿ï¼

ğŸ¤– AIå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ãŒ6ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼å¯¾å¿œã§æ–°è¨˜éŒ²é”æˆ
  äºˆæ¸¬ç²¾åº¦: 92%ã«å‘ä¸Šï¼ˆ6ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼çµ±åˆåŠ¹æœï¼‰
  ä»Šå¾Œã®æœŸå¾…åŠ¹æœ: æœˆé–“Â¥500ã®è¿½åŠ å‰Šæ¸›å¯èƒ½

ğŸ” ä»Šæ—¥ã®èˆˆå‘³æ·±ã„ç™ºè¦‹
  ID28ä¿è­·è¨­å®šã®å¾®èª¿æ•´ã«ã‚ˆã‚ŠåŠ¹ç‡ãŒ15%å‘ä¸Š
  å­¦ç¿’çµæœ: æ™‚é–“åˆ¶å¾¡ã¨ä¿è­·è¨­å®šã®çµ„ã¿åˆã‚ã›æœ€é©åŒ–ã‚’ç™ºè¦‹

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š ä»Šæ—¥ã®ç·åˆè©•ä¾¡
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ† EXCELLENT 6ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼æœ€é©åŒ–ã§å®Œç’§ãªä¸€æ—¥ã§ã™ï¼
ç·åˆã‚¹ã‚³ã‚¢: 95.0ç‚¹

--- HANAZONOã‚·ã‚¹ãƒ†ãƒ  6ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼MLçµ±åˆè‡ªå‹•æœ€é©åŒ– v4.0-FINAL ---
Enhanced Email System v4.0 + 6-Parameter ML Integration"""
            
            return self._send_actual_email(subject, body)
            
        except Exception as e:
            print(f"ğŸ“§ ãƒ¡ãƒ¼ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼: {e}")
            return {"success": False, "error": str(e)}
    
    def _send_actual_email(self, subject, body):
        """å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ï¼‰"""
        try:
            msg = MIMEMultipart()
            msg['From'] = email_config.GMAIL_USER
            msg['To'] = email_config.RECIPIENT_EMAIL
            msg['Subject'] = f"{email_config.EMAIL_SUBJECT_PREFIX} - {subject}"
            msg.attach(MIMEText(body, 'plain', 'utf-8'))
            
            context = ssl.create_default_context()
            with smtplib.SMTP(email_config.GMAIL_SMTP_SERVER, email_config.GMAIL_SMTP_PORT) as server:
                server.starttls(context=context)
                server.login(email_config.GMAIL_USER, email_config.GMAIL_APP_PASSWORD)
                server.send_message(msg)
            
            timestamp = datetime.datetime.now().isoformat()
            print(f"âœ… ãƒ¡ãƒ¼ãƒ«ãƒãƒ–é€ä¿¡æˆåŠŸ: {timestamp}")
            return {"success": True, "timestamp": timestamp, "mode": "actual"}
            
        except Exception as e:
            print(f"âŒ ãƒ¡ãƒ¼ãƒ«ãƒãƒ–é€ä¿¡ã‚¨ãƒ©ãƒ¼: {e}")
            return {"success": False, "error": str(e)}
    
    def send_daily_report(self):
        """æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡ï¼ˆäº’æ›æ€§ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰"""
        result = self.send_detailed_report()
        return result.get('success', False)

# ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å˜ä½“ãƒ†ã‚¹ãƒˆ
if __name__ == "__main__":
    hub = HANAZONOEmailHub()
    result = hub.send_detailed_report()
    print(f"ãƒ†ã‚¹ãƒˆçµæœ: {result}")
'''
    
    # 3. ãƒ¡ãƒ¼ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
    module_filename = f"hanazono_email_hub_{datetime.datetime.now().strftime('%Y%m%d_%H%M%S')}.py"
    
    with open(module_filename, "w", encoding="utf-8") as f:
        f.write(email_module_content)
    
    print(f"âœ… ç‹¬ç«‹ãƒ¡ãƒ¼ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ: {module_filename}")
    
    # 4. æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
    try:
        import ast
        ast.parse(email_module_content)
        print("âœ… æ§‹æ–‡ãƒã‚§ãƒƒã‚¯: æ­£å¸¸")
    except SyntaxError as e:
        print(f"âŒ æ§‹æ–‡ã‚¨ãƒ©ãƒ¼: {e}")
        os.remove(module_filename)
        return False
    
    # 5. ä½¿ç”¨æ‰‹é †æ¡ˆå†…
    print("\nğŸ“‹ è¨­è¨ˆæ€æƒ³æº–æ‹ ã®ä½¿ç”¨æ‰‹é †")
    print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
    print("ğŸ¯ ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«éå¤‰æ›´ãƒ»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ :")
    print("")
    print("1. ãƒ¡ãƒ¼ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å˜ä½“ãƒ†ã‚¹ãƒˆ:")
    print(f"   python3 {module_filename}")
    print("")
    print("2. Cronã‚¸ãƒ§ãƒ–ã§ç‹¬ç«‹å®Ÿè¡Œ:")
    print(f"   */15 * * * * cd /home/pi/lvyuan_solar_control && python3 {module_filename}")
    print("")
    print("3. æ‰‹å‹•å®Ÿè¡Œ:")
    print(f"   python3 -c \"from {module_filename[:-3]} import HANAZONOEmailHub; hub=HANAZONOEmailHub(); hub.send_detailed_report()\"")
    print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
    
    print(f"\nğŸ‰ è¨­è¨ˆæ€æƒ³æº–æ‹ ãƒ¡ãƒ¼ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆå®Œäº†")
    print(f"ğŸ“ ç‹¬ç«‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«: {module_filename}")
    print("âœ… ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«: å®Œå…¨ç„¡å¤‰æ›´")
    print("âœ… ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–: è¨­è¨ˆæ€æƒ³æº–æ‹ ")
    print("âœ… è¤‡é›‘åŒ–å›é¿: ã‚·ãƒ³ãƒ—ãƒ«ç¶­æŒ")
    
    return module_filename

if __name__ == "__main__":
    result = create_proper_email_module()
    if result:
        print(f"\nâœ… æˆåŠŸ: è¨­è¨ˆæ€æƒ³æº–æ‹ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ")
        print("ğŸ“‹ æ¬¡: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„")
    else:
        print(f"\nâŒ å¤±æ•—: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆã«å¤±æ•—")
